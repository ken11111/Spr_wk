# CRC最適化による想定外の性能劣化調査

**作成日**: 2025年12月29日
**Phase**: Phase 1.5 VGA性能最適化
**問題**: NuttX CRC16実装への置き換えで予期しない性能劣化が発生

---

## エグゼクティブサマリー

パケット化処理の最適化として、カスタムビット単位CRC16計算をNuttXのテーブルルックアップCRC16に置き換えたところ、パケット化レイテンシは改善したものの、**カメラレイテンシが6ms→315msへ50倍以上悪化**する予期しない問題が発生した。

詳細調査の結果、**CRC実装の互換性問題**（NuttXとカスタムは異なるCRCバリアント）を発見し、元の実装に戻したが、**性能は回復しなかった**。クリーンビルド、Spresense完全電源オフ（USB抜線）を実施しても状況は変わらず、カメラレイテンシは264msのまま劣化している。

**重要な発見**: Spresense側の完全電源オフでも性能が回復しないため、**問題はPC側またはカメラ環境にある**と判明。最有力仮説はPC側USB CDC ACMバッファの状態異常。次のステップとしてPC側USB接続の完全リセット（カーネルモジュールリロードまたはPC再起動）が必要。

---

## 目次

- [背景](#背景)
- [最適化の試み](#最適化の試み)
- [観測された性能劣化](#観測された性能劣化)
- [CRC互換性問題の発見](#crc互換性問題の発見)
- [想定外の事象](#想定外の事象)
- [性能劣化のメカニズム仮説](#性能劣化のメカニズム仮説)
- [次のステップ](#次のステップ)

---

## 背景

### Phase 1.5 の状況

**成功した設定** (2025-12-29 午前):
- CAMERA_BUFFER_NUM=3（V4L2ドライバー制限に合わせた設定）
- カスタムCRC16実装（ビット単位処理）
- **達成性能**: 7.0 fps、カメラレイテンシ 6.2 ms

**ボトルネック**:
- パケット化レイテンシ: 38.4 ms（目標4 msに対して9.6倍遅い）
- CRC16計算が91%を占める（~35 ms）

### 最適化の提案

**目標**: CRC16計算をビット単位処理からテーブルルックアップ方式に変更

**期待効果**:
- パケット化レイテンシ: 38.4 ms → 5~6 ms (-84~-86%)
- FPS: 7.0 fps → 9~10 fps (+28~+43%)
- 実装時間: 30分
- リスク: 低

---

## 最適化の試み

### 実装内容

**ファイル**: `apps/examples/security_camera/mjpeg_protocol.c`

#### 変更前（カスタム実装）

```c
uint16_t mjpeg_crc16_ccitt(const uint8_t *data, size_t len)
{
  uint16_t crc = 0xFFFF;  // 初期値
  size_t i;
  int j;

  for (i = 0; i < len; i++)
    {
      crc ^= (uint16_t)data[i] << 8;  // MSB-first

      for (j = 0; j < 8; j++)  // 8ビット処理
        {
          if (crc & 0x8000)
            {
              crc = (crc << 1) ^ 0x1021;  // 左シフト
            }
          else
            {
              crc = crc << 1;
            }
        }
    }

  return crc;
}
```

**特徴**:
- 初期値: 0xFFFF
- アルゴリズム: MSB-first（非反転）
- 多項式: 0x1021
- 処理: ビット単位（524,288回の演算/64KB）

#### 変更後（NuttX実装）

```c
#include <nuttx/crc16.h>

// mjpeg_crc16_ccitt()関数を削除

// mjpeg_pack_frame()内:
crc = crc16ccitt(packet, MJPEG_HEADER_SIZE + jpeg_size);
```

**NuttX実装の内部**:
```c
uint16_t crc16ccitt(FAR const uint8_t *src, size_t len)
{
  return crc16ccittpart(src, len, 0);  // 初期値 0x0000
}

uint16_t crc16ccittpart(FAR const uint8_t *src, size_t len,
                        uint16_t crc16val)
{
  for (i = 0; i < len; i++)
    {
      v = (v >> 8) ^ crc16ccitt_tab[(v ^ src[i]) & 0xff];  // LSB-first
    }
  return v;
}
```

**特徴**:
- 初期値: **0x0000**（カスタム実装と異なる！）
- アルゴリズム: **LSB-first（反転）**（カスタム実装と異なる！）
- 多項式: 0x1021（同じ）
- 処理: テーブルルックアップ（65,536回の演算/64KB）

---

## 観測された性能劣化

### テスト1: NuttX CRC16実装（1回目）

**日時**: 2025-12-29 10:52

| 指標 | Window 1 | Window 2 | Window 3 | 平均 |
|------|---------|---------|---------|------|
| **カメラレイテンシ** | **329.9 ms** | **313.2 ms** | **315.3 ms** | **319.5 ms** |
| パケット化レイテンシ | 11.7 ms | 12.0 ms | 12.0 ms | 11.9 ms |
| USB書き込み | 57.8 ms | 59.4 ms | 58.0 ms | 58.4 ms |
| **FPS** | **3.58 fps** | **3.66 fps** | **3.66 fps** | **3.63 fps** |

**問題点**:
- カメラレイテンシが **315 ms** に悪化（期待値: 6 ms、**50倍以上悪化**）
- FPS が **3.6 fps** に低下（期待値: 9-10 fps、**48%低下**）
- パケット化レイテンシは 12 ms に改善（期待値: 5-6 ms、目標の2倍）

### テスト2: NuttX CRC16実装（クリーンビルド後）

**日時**: 2025-12-29 10:59

ビルドアーティファクトの影響を排除するため、`make clean`後に再ビルドしてテスト。

| 指標 | Window 1 | Window 2 | Window 3 | 平均 |
|------|---------|---------|---------|------|
| **カメラレイテンシ** | **331.0 ms** | **316.4 ms** | **315.6 ms** | **321.0 ms** |
| パケット化レイテンシ | 11.8 ms | 12.0 ms | 12.0 ms | 11.9 ms |
| USB書き込み | 57.7 ms | 58.8 ms | 58.2 ms | 58.2 ms |
| **FPS** | **3.58 fps** | **3.66 fps** | **3.66 fps** | **3.63 fps** |

**結果**: クリーンビルドでも同じ劣化が再現。ビルドアーティファクトの問題ではない。

---

## CRC互換性問題の発見

### CRC実装の詳細比較

| 項目 | カスタム実装 | NuttX `crc16ccitt()` |
|------|------------|---------------------|
| **初期値** | `0xFFFF` | **`0x0000`** |
| **アルゴリズム** | MSB-first（非反転） | **LSB-first（反転）** |
| **シフト方向** | 左シフト (`<<`) | **右シフト (`>>`)** |
| **処理方式** | ビット単位ループ | テーブルルックアップ |
| **多項式** | 0x1021 | 0x1021 |
| **CRC-16バリアント** | CRC-16-CCITT-FALSE | **CRC-16-KERMIT系** |

### 互換性の問題

**結論**: 同じ多項式0x1021を使用しているが、**完全に異なるCRC値**を生成する。

**例**: 同じデータに対して
- カスタム実装: CRC = `0xD06F`
- NuttX実装: CRC = `0xF161` (異なる値)

### PC側への影響

**推測されるシナリオ**:

1. **パケット検証エラー**: PC側受信コードは元のCRC値（0xFFFF初期値、MSB-first）を期待
2. **受信バッファ滞留**: PC側がCRCエラーでパケットを破棄し続ける
3. **USB層フロー制御**: PC側バッファが満杯になり、USB転送が遅延
4. **カメラバッファへの背圧**: USB書き込みの遅延がカメラキャプチャに影響
5. **V4L2バッファ枯渇**: カメラバッファが解放されず、次のフレームを待つ時間が増大

**観測された兆候**:
- USB書き込みレイテンシは正常（59 ms程度）
- USB retries = 0（再送なし）
- しかし、カメラレイテンシが異常に高い（315 ms）

---

## 想定外の事象

### テスト3: カスタムCRC実装に復帰

**日時**: 2025-12-29 11:05

CRC互換性問題を解決するため、元のカスタムCRC実装に戻してテスト。

**期待**: カメラレイテンシが 6 ms に復帰、FPS が 7.0 fps に回復

| 指標 | Window 1 | Window 2 | Window 3 | 平均 |
|------|---------|---------|---------|------|
| **カメラレイテンシ** | **281.4 ms** | **259.7 ms** | **260.0 ms** | **267.0 ms** |
| パケット化レイテンシ | 37.7 ms | 38.5 ms | 38.5 ms | 38.2 ms |
| USB書き込み | 57.5 ms | 59.2 ms | 59.7 ms | 58.8 ms |
| **FPS** | **3.56 fps** | **3.66 fps** | **3.66 fps** | **3.63 fps** |

**結果**:
- ✅ パケット化レイテンシは元の 38 ms に戻った（期待通り）
- ❌ カメラレイテンシは **260 ms のまま**（改善せず！）
- ❌ FPS は **3.6 fps のまま**（改善せず！）

### テスト4: クリーンビルド + 完全電源オフ

**日時**: 2025-12-29 11:15

ビルドアーティファクトとデバイス状態の両方を排除するため、以下を実施:
1. `make clean`でクリーンビルド
2. **Spresense完全電源オフ**（USBケーブル抜線）
3. カスタムCRC実装で90フレームテスト

**期待**: カメラレイテンシが 6 ms に復帰、FPS が 7.0 fps に回復

| 指標 | Window 1 | Window 2 | Window 3 | 平均 |
|------|---------|---------|---------|------|
| **カメラレイテンシ** | **275.9 ms** | **257.6 ms** | **259.2 ms** | **264.2 ms** |
| パケット化レイテンシ | 38.3 ms | 38.5 ms | 38.5 ms | 38.4 ms |
| USB書き込み | 59.7 ms | 60.5 ms | 60.0 ms | 60.1 ms |
| **FPS** | **3.56 fps** | **3.66 fps** | **3.65 fps** | **3.62 fps** |

**結果**:
- ✅ パケット化レイテンシは正常（38.4 ms）
- ✅ USB書き込みレイテンシは正常（60.1 ms）
- ❌ カメラレイテンシは **264 ms のまま**（改善せず！）
- ❌ FPS は **3.6 fps のまま**（改善せず！）

**重要な発見**:
- **クリーンビルドでも性能は回復しない**
- **完全電源オフでも性能は回復しない** ← 極めて重要
- これはSpresense側の状態問題ではない可能性が高い

### 矛盾点

**元の成功テスト（同日午前）**:
- CAMERA_BUFFER_NUM=3
- カスタムCRC実装
- カメラレイテンシ: 6.2 ms
- FPS: 7.0 fps

**現在のテスト**:
- CAMERA_BUFFER_NUM=3（同じ）
- カスタムCRC実装（同じ）
- カメラレイテンシ: **260 ms**（40倍悪化）
- FPS: **3.6 fps**（50%低下）

**コードは同一**なのに、性能が大きく異なる。

---

## 電源オフテストによる仮説の絞り込み

### 排除された仮説

完全電源オフ（USB抜線）を実施しても性能が回復しなかったことで、以下の仮説は**排除できる**:

1. ❌ **仮説1: デバイス状態の異常**
   - 理由: 完全電源オフで全デバイス状態はクリアされる
   - 結果: 電源オフ後も性能劣化が継続

2. ❌ **仮説2: V4L2ドライバー状態の異常**
   - 理由: 電源オフでドライバー状態は完全初期化される
   - 結果: 電源オフ後も同じレイテンシパターン

3. ❌ **仮説3: システムタイマー・スケジューラの異常**
   - 理由: 電源オフでNuttX RTOSは完全リセットされる
   - 結果: 電源オフ後も同じ性能劣化

5. ❌ **仮説5: メモリリーク・断片化**
   - 理由: 電源オフでメモリ状態は完全クリア
   - 結果: 電源オフ後も性能は変わらず

### 残存する有力仮説

4. ✅ **仮説4: PC側USB CDC ACMバッファの状態**（最有力）
   - 理由: **Spresense側を電源オフしてもPC側はリセットされない**
   - 観測: USB書き込みレイテンシは正常だが、カメラレイテンシが異常
   - メカニズム: PC側バッファ満杯 → USB背圧 → V4L2バッファキュー遅延

### 新たな仮説

6. ⚠️ **カメラハードウェア状態の変化**
   - オートフォーカス/オートホワイトバランスの状態変化
   - カメラモジュールの温度や校正状態
   - レンズ位置の物理的変化

7. ⚠️ **環境要因による性能変化**
   - 照明条件の変化（より複雑なシーンになった）
   - JPEG圧縮効率の低下（全フレームが64KB上限に達している）
   - カメラが向いている方向や被写体の変化

---

## 性能劣化のメカニズム仮説（詳細）

### 仮説1: デバイス状態の異常

**説明**: 複数回のファームウェア更新とテストにより、デバイス（Spresense）が異常な状態になっている。

**根拠**:
- 同じコードで性能が異なる
- ハードウェアリセット（電源オフ/オン）を実施していない

**検証方法**:
1. デバイスの完全電源オフ（5秒以上）
2. 再起動後、同じファームウェアでテスト
3. 性能が回復するか確認

### 仮説2: V4L2ドライバー状態の異常

**説明**: カメラドライバー（V4L2）がバッファ管理で異常な状態になっている。

**根拠**:
- カメラレイテンシのみが異常に高い（315 ms → 260 ms）
- パケット化、USB書き込みは正常範囲
- バッファキューイングの不具合が疑われる

**可能性のあるメカニズム**:

```
正常時:
カメラ → [Buf0] → [Buf1] → [Buf2] → アプリ
         ↑_______________________|
         (即座に再キュー)

異常時:
カメラ → [Buf0] → ... 待機 260ms ... → アプリ
         ↑_______________________________|
         (再キューが遅延?)
```

**検証方法**:
1. カメラストリーミング停止
2. デバイス再起動
3. カメラストリーミング再開
4. バッファ状態をログで確認

### 仮説3: システムタイマー・スケジューラの異常

**説明**: NuttXのスケジューラーやタイマーが異常な状態になっている。

**根拠**:
- カメラレイテンシが一定値（260-280 ms）に収束
- この値は何らかのタイムアウト値の可能性
- NuttX RTOSのタスクスケジューリングに影響

**検証方法**:
1. デバイス再起動
2. 他のタスクの挙動を確認
3. タイムアウト設定を確認

### 仮説4: USB CDC ACMバッファの状態

**説明**: PC側のUSB CDC ACM受信バッファが満杯状態で、フロー制御が働いている。

**根拠**:
- NuttX CRC実装でPC側が無効なパケットを受信し続けた
- PC側バッファが詰まったまま
- カスタムCRCに戻してもPC側バッファがクリアされていない

**可能性のあるメカニズム**:

```
1. NuttX CRCでPC側に無効なパケットを大量送信
   → PC側受信バッファが満杯

2. カスタムCRCに戻す
   → PC側は有効なパケットを受信できるが、バッファが詰まっている

3. USB書き込みが遅延
   → カメラバッファに背圧
   → カメラレイテンシ増大
```

**検証方法**:
1. PC側のUSB接続を一度切断
2. PC側受信プログラムを再起動
3. USB再接続後テスト

### 仮説5: メモリリーク・断片化

**説明**: 複数回のテストでメモリリークやメモリ断片化が発生している。

**根拠**:
- 長時間稼働後の劣化に似た症状
- 複数回のファームウェア更新

**検証方法**:
1. デバイス再起動
2. メモリ使用状況を確認
3. メモリリークがないか確認

---

## 次のステップ

### 実施済みの対応

1. ✅ **CRC実装の復帰**
   - NuttX CRC → カスタムCRC実装に復帰
   - **結果**: パケット化レイテンシは正常化、カメラレイテンシは回復せず

2. ✅ **クリーンビルド**
   - `make clean`後に完全再ビルド
   - ビルドアーティファクトの影響を排除
   - **結果**: 性能は回復せず

3. ✅ **Spresense完全電源オフ**
   - USBケーブル抜線による完全電源オフ実施
   - 全デバイス状態をリセット
   - **結果**: 性能は回復せず（カメラレイテンシ 264 ms のまま）
   - **重要**: これによりSpresense側の状態問題は排除できる

### 残りの即座対応（優先度順）

1. **PC側USB接続の完全リセット**（最優先）
   - PC側のUSB接続を物理的に切断（5秒以上）
   - 受信プログラムを完全に停止
   - Linuxカーネルのusbモジュールをアンロード/リロード
   - PC再起動も検討
   - **理由**: Spresense電源オフでもPC側はリセットされない（最有力仮説）

2. **環境要因の確認**
   - カメラが向いている方向/被写体を確認
   - 照明条件を元の成功時と比較
   - カメラを物理的に動かして性能変化を確認
   - **理由**: JPEG圧縮効率の変化が影響している可能性

3. **ログ追加による詳細調査**
   - V4L2バッファキューイングのタイミングをログ
   - カメラDQBUF/QBUFの時間を測定
   - 270ms待機の発生箇所を特定
   - **目的**: カメラレイテンシ異常の根本原因を特定

### 中期的対応

1. **CRC最適化の再設計**
   - カスタムCRC実装をテーブルルックアップ化
   - PC側との互換性を維持しつつ高速化
   - 初期値0xFFFF、MSB-firstを維持

2. **メモリコピー最適化の検討**
   - パケット化レイテンシの残り 2.5 ms（memcpy）を削減
   - バッファ統合アーキテクチャの設計

---

## 結論

NuttX CRC16実装への置き換えは、以下の問題を引き起こした:

1. **CRC互換性問題**（想定内、解決済み）:
   - NuttXとカスタムCRCは異なるバリアントで互換性なし
   - PC側との通信プロトコル不一致
   - **対応**: カスタムCRC実装に復帰

2. **想定外の性能劣化**（原因不明、未解決）:
   - カスタムCRCに戻しても性能が回復しない
   - カメラレイテンシが **270 ms** のまま（正常時の **45倍**）
   - **クリーンビルドでも回復せず**
   - **デバイス再起動でも回復せず**
   - **同じコードで異なる性能** - ハードウェアまたはシステム状態の異常が疑われる

### 検証済み事項

| 対応 | 結果 | 排除できる仮説 |
|------|------|--------------|
| カスタムCRC実装に戻す | ❌ 性能回復せず | - |
| クリーンビルド | ❌ 性能回復せず | ビルドアーティファクト問題 |
| Spresense完全電源オフ | ❌ 性能回復せず | デバイス状態、V4L2ドライバー、タイマー、メモリリーク |

**重要な結論**: Spresense側の電源オフでも性能が回復しないため、**問題はPC側またはカメラハードウェア/環境にある**。

### 未検証の対応

1. **PC側USB接続の完全リセット**（最優先）
   - 理由: PC側バッファが詰まっている可能性（最有力仮説）
   - 方法: USB物理切断 + カーネルモジュールリロード + PC再起動
   - 優先度: **最高**

2. **環境要因の確認**
   - 理由: カメラが向いている方向や照明条件の変化
   - 方法: カメラ位置を変更して性能変化を観察
   - 優先度: 高

3. **詳細ログによる根本原因特定**
   - 理由: 264ms待機の発生箇所を特定
   - 方法: V4L2バッファキューイングのタイミングログ
   - 優先度: 中

### 現時点での推奨

**即座の対応（優先度順）**:

1. **PC側USB接続の完全リセット**（最優先）
   - 受信プログラムを完全停止
   - USB物理切断（5秒以上）
   - Linuxカーネルモジュールのアンロード/リロード:
     ```bash
     sudo modprobe -r cdc_acm
     sudo modprobe cdc_acm
     ```
   - 上記で改善しない場合、PC再起動を検討
   - 理由: Spresense電源オフでも回復しないため、PC側が最有力

2. **環境要因の確認**
   - カメラの向きや被写体を変更
   - 元の成功時と同じ環境にできるか確認
   - 理由: 全フレームがJPEG上限64KBに達している（圧縮効率低下の可能性）

**根本原因が特定されない場合**:
- V4L2バッファキューイングのタイミングログを追加
- カメラDQBUF/QBUF処理時間を詳細測定
- 264ms待機の発生箇所を特定

**CRC最適化の再開**:
- 性能が 7.0 fps に回復してから実施
- カスタムテーブルルックアップCRC実装（互換性維持）
- 期待効果: パケット化 38ms → 5-6ms

---

**調査担当**: Claude Code (Sonnet 4.5)
**ドキュメント作成**: 2025年12月29日
**最終更新**: 2025年12月29日 11:35
**ステータス**: Spresense側要因を排除、PC側USB状態が最有力仮説
