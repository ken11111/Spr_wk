@startuml USBæœ€é©åŒ–æˆ¦ç•¥ã®æ¯”è¼ƒ
!theme plain
skinparam defaultFontName "Noto Sans CJK JP, Arial"
skinparam backgroundColor white
skinparam shadowing false

title USBæ›¸ãè¾¼ã¿æœ€é©åŒ–æˆ¦ç•¥ã®æ¯”è¼ƒ

' Current sequential processing
card "ç¾åœ¨ã®å®Ÿè£…ï¼ˆé€æ¬¡å‡¦ç†ï¼‰" as current #FFE0E0 {
  rectangle "Frame N" as frame_n_current {
    rectangle "ã‚«ãƒ¡ãƒ©\n5.1ms" as cam_n_current #FFC0C0
    rectangle "ãƒ‘ã‚±ãƒƒãƒˆ\n8.7ms" as pack_n_current #FFB0B0
    rectangle "USBæ›¸è¾¼\n30.2ms" as usb_n_current #FFA0A0

    cam_n_current -right-> pack_n_current
    pack_n_current -right-> usb_n_current
  }

  rectangle "Frame N+1" as frame_n1_current {
    rectangle "ã‚«ãƒ¡ãƒ©\n5.1ms" as cam_n1_current #FFC0C0
    rectangle "ãƒ‘ã‚±ãƒƒãƒˆ\n8.7ms" as pack_n1_current #FFB0B0
    rectangle "USBæ›¸è¾¼\n30.2ms" as usb_n1_current #FFA0A0

    cam_n1_current -right-> pack_n1_current
    pack_n1_current -right-> usb_n1_current
  }

  usb_n_current -down-> cam_n1_current : **44.0msé–“éš”**

  note right of current
    **å•é¡Œç‚¹**:
    â€¢ USBè»¢é€å®Œäº†ã¾ã§æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ é–‹å§‹ä¸å¯
    â€¢ CPUå¾…æ©Ÿæ™‚é–“ãŒé•·ã„(30.2ms)
    â€¢ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åŠ¹ç‡ãŒä½ã„

    **æ€§èƒ½**:
    â€¢ ãƒ•ãƒ¬ãƒ¼ãƒ é–“éš”: 44.0 ms
    â€¢ FPS: 11.0 fps
  end note
}

|||

' Optimized pipeline processing
card "æœ€é©åŒ–å¾Œï¼ˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å‡¦ç†ï¼‰" as optimized #E0FFE0 {
  rectangle "Frame N" as frame_n_opt {
    rectangle "ã‚«ãƒ¡ãƒ©\n5.1ms" as cam_n_opt #C0FFC0
    rectangle "ãƒ‘ã‚±ãƒƒãƒˆ\n8.7ms" as pack_n_opt #B0FFB0
    rectangle "USBé–‹å§‹" as usb_start_n #A0FFA0
  }

  rectangle "Frame N+1ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰" as frame_n1_opt {
    rectangle "ã‚«ãƒ¡ãƒ©\n5.1ms" as cam_n1_opt #C0FFC0
    rectangle "ãƒ‘ã‚±ãƒƒãƒˆ\n8.7ms" as pack_n1_opt #B0FFB0
    rectangle "USBé–‹å§‹" as usb_start_n1 #A0FFA0
  }

  rectangle "USB Nè»¢é€ä¸­\n27.4ms" as usb_n_bg #D0FFD0
  rectangle "USB N+1è»¢é€ä¸­\n27.4ms" as usb_n1_bg #D0FFD0

  cam_n_opt -right-> pack_n_opt
  pack_n_opt -right-> usb_start_n
  usb_start_n -down-> usb_n_bg : éåŒæœŸè»¢é€é–‹å§‹

  usb_start_n -down-> cam_n1_opt : ã™ãæ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ é–‹å§‹
  cam_n1_opt -right-> pack_n1_opt
  pack_n1_opt -right-> usb_start_n1

  usb_n_bg -down-> usb_n1_bg : ãƒãƒƒãƒ•ã‚¡åˆ‡æ›¿

  note right of optimized
    **æ”¹å–„ç‚¹**:
    â€¢ USBè»¢é€ã¨æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†ãŒä¸¦åˆ—
    â€¢ CPUåŠ¹ç‡å‘ä¸Š
    â€¢ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åŒ–ã«ã‚ˆã‚‹é«˜é€ŸåŒ–

    **æ€§èƒ½**:
    â€¢ ãƒ•ãƒ¬ãƒ¼ãƒ é–“éš”: 38-39 ms
    â€¢ FPS: 12.5-13.2 fps
    â€¢ **æ”¹å–„: +1.5-2.2 fps** ğŸ¯
  end note
}

|||

' Optimization strategies comparison table
rectangle "æœ€é©åŒ–æˆ¦ç•¥ã®æ¯”è¼ƒ" as strategies #F0F8FF {
  card "æˆ¦ç•¥1: ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºæœ€é©åŒ–" as strategy1 {
    note
      **å¤‰æ›´**: 8KB â†’ 64KB
      **åŠ¹æœ**: write()å‘¼å‡º 5å›â†’1å›
      **æ”¹å–„**: -0.8ms (-2.7%)
      **å·¥æ•°**: 5åˆ†
      **å„ªå…ˆåº¦**: â­â­â­â­â­
    end note
  }

  card "æˆ¦ç•¥2: CDC-ACMè¨­å®šæœ€é©åŒ–" as strategy2 {
    note
      **å¤‰æ›´**: é€ä¿¡ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºèª¿æ•´
      **åŠ¹æœ**: USBè»¢é€åŠ¹ç‡å‘ä¸Š
      **æ”¹å–„**: -1ï½2ms (-3ï½7%)
      **å·¥æ•°**: 30åˆ†
      **å„ªå…ˆåº¦**: â­â­â­â­â­
    end note
  }

  card "æˆ¦ç•¥3: ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åŒ–" as strategy3 {
    note
      **å¤‰æ›´**: ãƒ€ãƒ–ãƒ«ãƒãƒƒãƒ•ã‚¡ + éåŒæœŸ
      **åŠ¹æœ**: ä¸¦åˆ—å®Ÿè¡Œ
      **æ”¹å–„**: -5ï½6ms (ãƒ•ãƒ¬ãƒ¼ãƒ é–“éš”)
      **å·¥æ•°**: 2-3æ™‚é–“
      **å„ªå…ˆåº¦**: â­â­â­â­
    end note
  }

  card "æˆ¦ç•¥4: DMAè»¢é€" as strategy4 {
    note
      **å¤‰æ›´**: DMAæœ‰åŠ¹åŒ–
      **åŠ¹æœ**: CPUè² è·å‰Šæ¸›
      **æ”¹å–„**: -0.5ï½1.5ms (ä¸ç¢ºå®Ÿ)
      **å·¥æ•°**: 4-8æ™‚é–“
      **å„ªå…ˆåº¦**: â­â­ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
    end note
  }
}

' Performance timeline
card "æ€§èƒ½æ”¹å–„ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³" as timeline #FFFACD {
  rectangle "ç¾åœ¨\n11.0 fps" as current_perf #FFE0E0
  rectangle "ãƒ•ã‚§ãƒ¼ã‚º1\n11.4-11.6 fps" as phase1_perf #FFD0C0
  rectangle "ãƒ•ã‚§ãƒ¼ã‚º2\n12.5-13.2 fps" as phase2_perf #C0FFC0
  rectangle "ç›®æ¨™\n13-14 fps" as target_perf #A0FFA0

  current_perf -right-> phase1_perf : ãƒãƒƒãƒ•ã‚¡+CDC-ACM\n(35åˆ†)
  phase1_perf -right-> phase2_perf : ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åŒ–\n(2-3æ™‚é–“)
  phase2_perf -right-> target_perf : ç›®æ¨™é”æˆ âœ…

  note bottom of timeline
    **æ¨å¥¨å®Ÿè£…é †åº**:
    1. ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºæœ€é©åŒ– (5åˆ†)
    2. CDC-ACMè¨­å®šèª¿æ•´ (30åˆ†)
    3. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åŒ–å®Ÿè£… (2-3æ™‚é–“)

    **åˆè¨ˆå·¥æ•°**: ç´„3æ™‚é–“
    **æœŸå¾…åŠ¹æœ**: +1.5ï½2.2 fps
  end note
}

' Hardware constraint visualization
card "ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶ç´„ã®åˆ†æ" as hw_constraint #E3F2FD {
  rectangle "USBè»¢é€æ™‚é–“ 30.2ms ã®å†…è¨³" as breakdown {
    rectangle "USBè»¢é€\n(ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢)\n27.4ms\n90.7%" as hw_transfer #B0D0FF
    rectangle "ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰\n2.8ms\n9.3%" as overhead {
      rectangle "ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«\n1.0ms" as syscall #D0E0FF
      rectangle "ãƒ‰ãƒ©ã‚¤ãƒå‡¦ç†\n1.0ms" as driver #D0E0FF
      rectangle "ãƒãƒƒãƒ•ã‚¡ã‚³ãƒ”ãƒ¼\n0.8ms" as copy #D0E0FF
    }
  }

  note right of hw_constraint
    **é‡è¦ãªæ´å¯Ÿ**:

    USB Full Speedå¸¯åŸŸå¹…: 12 Mbps
    ç†è«–è»¢é€æ™‚é–“: 41.1KB Ã· 1.5MB/s = **27.4ms**

    ç¾åœ¨ã®USBè»¢é€ã¯æ—¢ã«**éå¸¸ã«åŠ¹ç‡çš„**:
    â€¢ å¸¯åŸŸå¹…åˆ©ç”¨ç‡: 90.7%
    â€¢ ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰: ã‚ãšã‹9.3%

    **çµè«–**: å¤§å¹…ãªæ”¹å–„ã¯å›°é›£
    â†’ **ä¸¦åˆ—åŒ–ãŒæœ€ã‚‚åŠ¹æœçš„**
  end note
}

footer USBæœ€é©åŒ–æˆ¦ç•¥ - Phase 1.5 æ€§èƒ½æœ€é©åŒ–

@enduml
