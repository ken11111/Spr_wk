# Phase 3: アプリケーションの提案から実装

## 目的
BMI160 IMUセンサーを使った姿勢推定・位置推定アプリケーションの設計と実装

## 📊 フローチャート

**視覚的な手順**: [phase3_application_development_flow.puml](../../diagrams/phase3_application_development_flow.puml)

Phase 3の全体フローをPlantUML図で確認できます。図には以下の情報が含まれています：
- 要件定義の手順
- センサードライバー確認フロー
- センサーデータ取得の実装
- データ処理パイプライン（フィルタリング、AHRS）
- 出力・表示方法の選択
- ビルドとテストの手順
- デバッグと性能最適化

**カメラアプリケーションの場合**:
- [camera_application_flow.puml](../../diagrams/camera_application_flow.puml) - カメラ専用フロー

## Claude Codeへの効果的なプロンプト例

### プロンプト1: アプリケーション要件の整理

```
BMI160 IMUセンサーを使ったアプリケーションを開発したいです。
要件を整理し、実装方針を提案してください。

【ハードウェア】
- Spresense Main Board
- BMI160 6軸IMUセンサー（加速度+ジャイロ）

【やりたいこと】
1. BMI160からセンサーデータを取得
2. Roll/Pitch/Yaw角度を計算（姿勢推定）
3. 加速度から位置を推定
4. リアルタイムでデータを表示

【質問】
1. 姿勢推定にはどのアルゴリズムが適していますか？
2. Spresense SDKに利用可能なライブラリはありますか？
3. 位置推定の実装方法と注意点は？
4. サンプリングレートは何Hzが適切ですか？

【依頼】
技術的な実装方針を提案してください。
特に、既存のSpresense SDKライブラリ（AHRS等）の活用方法を教えてください。
```

**ポイント**:
- ハードウェア情報を明確に
- やりたいことを具体的に列挙
- アルゴリズム選定をAIに相談
- 既存ライブラリの活用を確認

---

### プロンプト2: アーキテクチャ設計

```
BMI160姿勢推定アプリのアーキテクチャを設計したいです。

【技術選定】
- 姿勢推定: Madgwick AHRSアルゴリズム
- 既存ライブラリ: sdk/../externals/ahrs/ を利用
- サンプリング: 100Hz
- 出力: 5秒ごとにコンソール表示

【質問】
1. ファイル構成はどうすべきですか？
2. モジュール分割の方針は？
3. メモリ使用量の見積もりは？
4. スタックサイズはどの程度必要ですか？

【依頼】
以下の設計を提案してください：
- ファイル構成（.c/.hファイルの分割方針）
- 各モジュールの責任範囲
- データフロー（センサー読取 → AHRS → 表示）
- メモリ・スタック要件

NuttX/Spresense環境のベストプラクティスに従って設計してください。
```

**ポイント**:
- 技術選定結果を共有
- 具体的な要件（サンプリング、出力）を明示
- メモリ要件を確認（組み込み環境では重要）
- ベストプラクティスを求める

---

### プロンプト3: センサーデータ取得の実装

```
BMI160センサーからデータを取得する部分を実装したいです。

【環境情報】
- SDK: Spresense SDK v3.4.5
- センサー: BMI160（/dev/accel0, /dev/gyro0）
- 必要なデータ: 加速度(ax,ay,az), 角速度(gx,gy,gz)

【質問】
1. Spresense SDKでのセンサーアクセス方法は？
2. センサーデバイスのオープン・設定・読取の手順は？
3. エラーハンドリングはどうすべきですか？
4. サンプリングレート100Hzの設定方法は？

【依頼】
以下のコードを実装してください：
- センサーデバイスのオープン
- サンプリングレート設定（100Hz）
- データ読取ループ
- 適切なエラーハンドリング

Spresense SDK v3.4.5のAPIに準拠した実装をお願いします。
```

**ポイント**:
- デバイスパスを明示
- 必要なデータ項目を列挙
- API準拠を明示的に要求
- エラーハンドリングを忘れずに

---

### プロンプト4: Madgwick AHRS統合

```
Madgwick AHRSライブラリを統合して姿勢推定を実装したいです。

【ライブラリ情報】
- パス: ~/Spr_ws/spresense/externals/ahrs/src/MadgwickAHRS/
- 提供API: MadgwickAHRSInit, MadgwickAHRSUpdate等

【実装したいこと】
1. AHRSの初期化（beta=0.1, サンプリングレート100Hz）
2. センサーデータをAHRSにフィード
3. クォータニオンからオイラー角（Roll/Pitch/Yaw）に変換
4. 単位変換（度/秒 → ラジアン/秒）

【質問】
1. AHRSライブラリのヘッダーファイルのインクルード方法は？
2. 初期化パラメータ（beta値）の推奨値は？
3. クォータニオン→オイラー角変換の実装は？
4. ジンバルロック対策は必要ですか？

【依頼】
orientation_calc.c/.h ファイルを実装してください。
- AHRS初期化関数
- センサーデータ更新関数
- オイラー角取得関数

コメントで各処理の意味を説明してください。
```

**ポイント**:
- ライブラリのパスを明示
- 具体的なパラメータ値を質問
- 単位変換の必要性を確認
- コメント付きコードを依頼

---

### プロンプト5: 位置推定の実装

```
加速度の二重積分で位置を推定する機能を実装したいです。

【実装方針】
1. 姿勢角を使って重力成分を除去
2. 線形加速度を抽出
3. 速度を積分（一重積分）
4. 位置を積分（二重積分）

【課題】
- ドリフト誤差の蓄積は避けられないことを理解している
- まずは基本実装を行い、後で改善を検討

【質問】
1. 重力ベクトルの回転変換の実装方法は？
2. 積分の離散化（台形則 vs オイラー法）の推奨は？
3. ドリフト対策として何ができますか？
4. メモリ使用量はどの程度ですか？

【依頼】
position_estimator.c/.h ファイルを実装してください。
- 位置推定器の初期化
- 加速度・姿勢データからの位置更新
- 現在位置の取得

ドリフトが発生することを前提とした実装で構いません。
コメントで計算の流れを説明してください。
```

**ポイント**:
- 実装方針を明示（AIの理解を助ける）
- 課題を認識していることを伝える
- 完璧を求めない（まず動くものを）
- 計算の説明を求める

---

### プロンプト6: メインプログラムの実装

```
全てを統合するメインプログラムを実装したいです。

【機能要件】
1. BMI160センサーのオープン
2. AHRS初期化
3. 位置推定器初期化
4. メインループ（100Hz）
   - センサーデータ読取
   - 姿勢更新
   - 位置更新
   - 5秒ごとに結果表示
5. Ctrl+Cで終了

【出力フォーマット】
```
Time(ms)      Roll    Pitch      Yaw   |     X       Y       Z
                [deg]   [deg]    [deg]  |    [m]     [m]     [m]
---------------------------------------------------------------
[  123456] Roll:  12.34° Pitch:  56.78° Yaw:  90.12° | X:  1.23m Y:  4.56m Z:  7.89m
```

【質問】
1. 100Hzループの実装方法（usleep? nanosleep?）
2. シグナルハンドリング（Ctrl+C）の実装は？
3. タイムスタンプの取得方法は？
4. printf vs fprintf の推奨は？

【依頼】
bmi160_orientation_main.c を実装してください。
NuttXアプリケーションの標準的な構造に従ってください。
```

**ポイント**:
- 機能要件を箇条書きで明確化
- 出力フォーマットを具体的に示す
- タイミング制御の方法を確認
- NuttX標準構造への準拠を依頼

---

### プロンプト7: ビルド設定の最適化

```
アプリケーション実装が完了しました。
ビルド設定を最適化したいです。

【現状】
- ソースファイル: 5個（.c 3個、.h 2個）
- 依存ライブラリ: AHRS (externals/ahrs/)
- 想定スタックサイズ: 4096 bytes

【質問】
1. Makefileでの外部ライブラリインクルードパスの指定方法は？
2. スタックサイズ4096は適切ですか？
3. コンパイラ最適化オプション（-O2等）は設定すべきですか？
4. デバッグ情報の出力設定は？

【依頼】
以下を最適化してください：
- Makefile のCFLAGS設定
- スタックサイズの妥当性確認
- 依存関係の明示的な記述

ビルドエラーが出る場合の対処法も教えてください。
```

**ポイント**:
- 現状を整理して共有
- 外部ライブラリのリンク方法を確認
- リソース要件の妥当性確認
- エラー時の対処も事前に質問

---

### プロンプト8: デバッグとテスト

```
実装したアプリをデバッグしたいです。

【現状】
- ビルド: 成功
- 実行: NuttShellで起動可能
- 問題: センサーデータが正しく取得できない

【エラー内容】
```
BMI160 sensor opened successfully
Starting data acquisition...
ERROR: Failed to read accel data: -1
```

【質問】
1. このエラーの原因として考えられることは？
2. センサーデバイスの状態確認方法は？
3. デバッグ出力を追加すべき箇所は？
4. センサー設定（レンジ、レート）の確認方法は？

【依頼】
以下のデバッグ手順を提案してください：
1. センサーデバイスの存在確認
2. デバイスパーミッション確認
3. センサー設定状態の確認
4. 詳細なエラーログ出力の追加

段階的にデバッグできるように、優先順位をつけて提案してください。
```

**ポイント**:
- エラーメッセージを正確に記載
- 現状（どこまでうまくいったか）を明示
- 段階的デバッグを依頼
- 優先順位付けを求める

---

### プロンプト9: 性能最適化

```
アプリは動作していますが、性能を最適化したいです。

【現状】
- 目標: 100Hzサンプリング
- 実測: 約95Hz（若干遅い）
- CPU使用率: 不明
- メモリ使用: 不明

【最適化したい点】
1. サンプリングレートを正確に100Hzにする
2. CPU使用率を下げる
3. メモリ使用量を最小化

【質問】
1. サンプリングレートのズレの原因は？
2. printfの頻度を下げる以外の最適化方法は？
3. 浮動小数点演算の最適化方法は？
4. タスク優先度の調整は効果的ですか？

【依頼】
以下の最適化案を提案してください：
- タイミング精度の改善
- 計算処理の最適化
- メモリ使用の最適化

トレードオフ（精度 vs 性能）も説明してください。
```

**ポイント**:
- 現状の性能を定量的に記載
- 最適化目標を明確に
- トレードオフの説明を求める

---

## このフェーズで達成すべきゴール

✅ センサーデータ取得の実装
✅ Madgwick AHRS統合と姿勢推定
✅ 位置推定の実装（ドリフト含む）
✅ リアルタイム表示の実装
✅ 100Hz安定動作
✅ エラーハンドリングの実装

---

## コード品質向上のプロンプト

### コードレビュー依頼

```
実装したコードをレビューしてください。

【確認してほしい点】
1. メモリリークの可能性
2. エラーハンドリングの適切性
3. NuttXコーディング規約への準拠
4. コメントの充実度
5. 保守性（可読性、モジュール性）

【依頼】
以下のファイルをレビューし、改善提案をしてください：
- bmi160_orientation_main.c
- orientation_calc.c
- position_estimator.c

重大な問題、改善提案、ベストプラクティスの3段階で指摘してください。
```

### ドキュメント作成依頼

```
実装したアプリケーションのREADMEを作成してください。

【含めてほしい内容】
1. アプリケーション概要
2. 機能説明
3. 使用方法
4. ビルド方法
5. トラブルシューティング
6. 技術的詳細（アルゴリズム説明）
7. 既知の制限事項

【スタイル】
- Markdown形式
- 初心者にも理解できる説明
- コード例を含める
- 図があるとベター（テキストで説明）

ソースコードを読み取って、正確なREADMEを生成してください。
```

---

## トラブルシューティング

### センサーデータ取得エラー

```
センサーからデータが取得できません。

【エラー】
[エラーメッセージを貼り付け]

【確認済み】
- デバイスファイル存在: /dev/accel0, /dev/gyro0 確認済み
- パーミッション: OK

【依頼】
以下を調査してください：
1. センサードライバの初期化状態
2. デバイス設定（レンジ、レート）
3. サンプルコード（sixaxis等）との比較
4. エラーコードの意味

解決方法を段階的に提案してください。
```

### AHRSの発散

```
AHRSの計算結果が発散します。

【症状】
- 初期は正常
- 数分後にRoll/Pitch角度が異常値
- Yaw角度が高速回転

【質問】
1. beta値の調整が必要ですか？
2. センサーデータの単位変換に誤りがありますか？
3. 更新レートの設定が間違っていますか？

【依頼】
AHRS関連のコードをレビューし、問題箇所を特定してください。
特に、単位変換と更新レート設定を重点的に確認してください。
```

---

## 効果的なプロンプトのコツ

1. **要件を具体的に**: 「センサーアプリ作って」ではなく、機能を列挙
2. **技術選定を相談**: アルゴリズムや手法をAIに提案させる
3. **段階的実装**: 一度に全てではなく、モジュール単位で実装
4. **コメント付きコード**: 実装の意図を理解するためコメントを依頼
5. **レビューを依頼**: 実装後は必ずコードレビューを依頼

---

## 実装完了後のチェックリスト

- [ ] 全ソースファイルのコンパイル成功
- [ ] センサーデータ取得が正常動作
- [ ] 姿勢角（Roll/Pitch/Yaw）が妥当な値
- [ ] 100Hzで安定動作
- [ ] エラー時に適切なメッセージ表示
- [ ] メモリリークなし
- [ ] ドキュメント（README）作成済み
- [ ] コードコメント充実

---

**作成日**: 2025-12-14
**開発アルゴリズム**: Madgwick AHRS
**想定時間**: 3-5時間
