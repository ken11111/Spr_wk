# Phase 1: 最新環境の確認と構築

## 目的
古いSpresense SDK環境を最新版にアップデートし、開発環境を整える

## 📊 フローチャート

**視覚的な手順**: [phase1_environment_setup_flow.puml](../../diagrams/phase1_environment_setup_flow.puml)

Phase 1の全体フローをPlantUML図で確認できます。図には以下の情報が含まれています：
- 現状確認の手順
- ツールチェーンのインストールフロー
- PATH設定の方法
- ビルドテストの手順
- エラー時の分岐処理
- デバイス接続確認（オプション）

## Claude Codeへの効果的なプロンプト例

### プロンプト1: 現状確認と診断

```
Spresense SDKの開発環境を数年ぶりに使います。
以下の情報を確認して、現在の環境状態を診断してください。

【環境情報】
- 作業ディレクトリ: ~/Spr_ws/spresense/
- OS: WSL2 (Ubuntu on Windows 11)
- 前回使用したSDKバージョン: 不明（おそらく古い）

【確認してほしいこと】
1. 現在インストールされているSDKのバージョン
2. 利用可能な最新のSDKバージョン
3. ツールチェーン（ARM GCC）の状態
4. サブモジュールの同期状態

【実行してほしいコマンド】
必要なファイルの読み取りやコマンド実行を提案してください。
```

**ポイント**:
- 作業ディレクトリを明確に伝える
- OSとWSL2環境であることを伝える（後のUSB設定に影響）
- 「診断」という言葉で包括的なチェックを依頼

---

### プロンプト2: アップデート計画の策定

```
現在のSDKがv3.0.0であることがわかりました。
最新のv3.4.5にアップデートしたいです。

【現状】
- spresenseリポジトリ: ~/Spr_ws/spresense/
- 現在のブランチ/タグ: v3.0.0
- 既存の開発物: 特になし（クリーンにアップデート可能）

【要望】
1. v3.4.5へのアップデート手順を段階的に提示
2. サブモジュールの更新方法
3. 設定のクリーンアップ方法
4. リスクと注意点の説明

各ステップで実行すべきコマンドを明示してください。
また、各ステップ実行後に確認すべきポイントも教えてください。
```

**ポイント**:
- 現在のバージョンと目標バージョンを明示
- 「段階的に」と指定して、一度に全部実行しないよう誘導
- 確認ポイントを求めることで、トラブル早期発見

---

### プロンプト3: ツールチェーンのインストール

```
Spresense SDK v3.4.5に必要な開発ツールをインストールします。

【環境】
- SDK path: ~/Spr_ws/spresense/sdk/
- WSL2 Ubuntu環境

【実施したいこと】
1. ARM GCCツールチェーンのインストール
2. 必要なビルドツールの確認とインストール
3. PATHの設定
4. インストール後の動作確認

【質問】
- spresense-toolsリポジトリを使う方法が推奨されていますか？
- インストール先ディレクトリはどこが適切ですか？
- インストール後、.bashrcなどに設定を追加すべきですか？

段階的に進めたいので、1つずつ確認しながら実行できるようにしてください。
```

**ポイント**:
- 具体的な質問を含める（AIが選択肢を提示しやすい）
- 環境の永続化（.bashrc）についても考慮

---

### プロンプト4: ビルド確認

```
開発環境のセットアップが完了しました。
デフォルト設定でビルドして、環境が正しく動作することを確認したいです。

【確認済み】
- SDK: v3.4.5
- ARM GCC: 12.2.1 (PATH設定済み)
- サブモジュール: 更新済み

【実行したいこと】
1. デフォルト設定の適用（./tools/config.py）
2. クリーンビルドの実行
3. ビルド成功の確認（nuttx.spk生成）
4. ファームウェアサイズの確認

【質問】
- ビルドに失敗した場合、どのログを確認すべきですか？
- ビルド時間はどのくらいかかりますか？（-j4オプションの効果）

エラーが出た場合は、ログを共有しますので、原因分析をお願いします。
```

**ポイント**:
- 確認済み事項を明示（どこまで進んでいるか明確に）
- エラー時の対応を事前に質問
- ビルド成功の判断基準を求める

---

## このフェーズで達成すべきゴール

✅ SDK v3.4.5のインストール完了
✅ ARM GCC 12.2.1のインストールと動作確認
✅ デフォルト設定でのビルド成功
✅ nuttx.spk (約170KB程度) の生成確認

---

## 次のフェーズへの準備

Phase 2に進む前に、以下を確認：
- [ ] `arm-none-eabi-gcc --version` でバージョン表示
- [ ] `make` が正常に完了
- [ ] `nuttx/nuttx.spk` ファイルが存在
- [ ] ビルドログに重大なエラーがない

---

## よくあるトラブルと対処

### トラブル1: サブモジュール更新エラー
```
エラーメッセージをClaude Codeに共有し、以下を依頼：
「サブモジュールの更新でエラーが出ました。
以下のエラーログから原因を特定し、解決方法を提案してください。」
```

### トラブル2: ARM GCCが見つからない
```
「arm-none-eabi-gccが見つかりません。
PATHの設定が正しいか確認し、修正方法を提案してください。
現在のPATH: [echo $PATH の結果を貼り付け]
インストール先: ~/spresenseenv/usr/bin/」
```

### トラブル3: ビルドエラー
```
「ビルドでエラーが発生しました。
以下のエラーログから原因を分析してください。

[エラーログを貼り付け]

特に注目すべき行や、解決のための手順を教えてください。」
```

---

## 効果的なプロンプトのコツ

1. **段階的に進める**: 一度に全てを実行せず、1ステップずつ確認
2. **環境情報を明示**: OS、ディレクトリ、バージョンを常に伝える
3. **エラーは全文共有**: エラーメッセージは省略せずに全て共有
4. **達成状況を報告**: 各ステップ後に「成功しました」と報告
5. **質問を具体的に**: 「うまくいきません」ではなく「このエラーが出ます」

---

**作成日**: 2025-12-14
**対象SDK**: Spresense SDK v3.4.5
**想定時間**: 1-2時間
