# 要求仕様確定による変更点サマリー

**作成日**: 2025-12-15
**対象**: 標準構成案 → 確定仕様への変更

---

## 📊 主要な変更点

### 1. 映像仕様の変更 ⚠️ **影響大**

| 項目 | 標準構成案 | 確定仕様 | 影響 |
|------|----------|---------|------|
| **解像度** | 1280x720 (HD) | **1920x1080 (Full HD)** | ⚠️ 帯域幅2倍、ストレージ2倍 |
| **FPS** | 30 | 30 | 変更なし |
| **HDR** | なし | **有効** | ⚠️ 処理負荷増、遅延増の可能性 |
| **圧縮** | H.264 | H.264 | 変更なし |
| **ビットレート** | 2 Mbps | **3-6 Mbps** | ⚠️ 帯域幅3倍 |

**技術的影響**:
- **帯域幅**: 2 Mbps → 3-6 Mbps（WiFiは問題なし、USBは厳しい）
- **ストレージ**: 900 MB/時 → **2.25 GB/時**（2.5倍）
- **100GBでの保存時間**: 約111時間 → **約44時間**（半分以下）
- **推奨ストレージ**: 200 GB → **300 GB以上**

---

### 2. 通信方式の変更 ⚠️ **影響大**

| 項目 | 標準構成案 | 確定仕様 |
|------|----------|---------|
| **Phase 1** | USB CDC | **USB CDC**（変更なし） |
| **Phase 2** | USB CDC継続 | **WiFi** |
| **プロトコル** | カスタムバイナリ | **RTSP (標準)** |

**技術的影響**:

#### ✅ メリット
- **WiFi**:
  - 無線化により設置場所自由
  - 帯域幅十分（Full HD対応）
  - 複数カメラ拡張容易

- **RTSP**:
  - 標準プロトコル（RFC 2326）
  - 既存ツール利用可能（VLC, FFmpeg等）
  - 将来のWeb UI拡張が容易

#### ⚠️ デメリット・追加作業
- **WiFi**:
  - 拡張ボード必要（iS110B: 約5,000円）
  - WiFi設定の複雑さ
  - 電波状況による不安定性

- **RTSP**:
  - 実装複雑化（プロトコルスタック）
  - Spresense側: RTSPサーバ実装
  - PC側: RTSPクライアント実装
  - デバッグ難易度上昇

---

### 3. 録画機能の拡張 ⚠️ **機能増加**

| 項目 | 標準構成案 | 確定仕様 |
|------|----------|---------|
| **録画モード** | 常時録画のみ | **4モード対応** |

#### 実装する録画モード

1. **手動録画**（Phase 1）
   - ユーザーがUI/コマンドで開始/停止
   - 実装難易度: 低

2. **常時録画**（Phase 2）
   - 起動から終了まで自動
   - 実装難易度: 低

3. **動き検出録画**（Phase 2）
   - Spresense側で動き検出時のみ
   - 実装難易度: 中
   - 追加機能: プリバッファ（検出前5秒も記録）

4. **スケジュール録画**（Phase 2）
   - 指定時間帯のみ（例: 22:00-06:00）
   - 実装難易度: 低
   - 追加機能: 設定ファイル管理

**技術的影響**:
- 録画制御ロジック複雑化
- 設定ファイル管理必要
- モード切り替えUI必要

---

### 4. 動き検出の早期実装 ⚠️ **Phase変更**

| 項目 | 標準構成案 | 確定仕様 |
|------|----------|---------|
| **実装時期** | Phase 2 | **Phase 1** |
| **検出場所** | 未定 | **Spresense側** |

**技術的影響**:

#### Spresense側実装の課題
- **RAM制約**: 1.5MB（Full HDバッファは外部メモリ必要）
- **アルゴリズム**: 軽量化必須（フレーム差分法）
- **処理負荷**: H.264エンコードと並行実行

#### 実装方針
1. YUVフレーム間の差分検出
2. ブロック単位での変化検出（8x8ブロック）
3. 閾値設定可能（config）
4. PC側への通知（RTSP拡張ヘッダ or UDP）

**追加工数**: Phase 1で+2-3日

---

### 5. ストレージ管理の変更 ✅ **柔軟性向上**

| 項目 | 標準構成案 | 確定仕様 |
|------|----------|---------|
| **管理方式** | 7日間固定 | **容量制限（設定変更可能）** |
| **デフォルト** | 7日間 | 100 GB |
| **分割** | 1時間固定 | **時間分割（設定変更可能）** |

**メリット**:
- ユーザーの環境に応じて柔軟に設定可能
- ストレージ容量に合わせた運用

**実装追加**:
- 設定ファイル管理（TOML）
- 動的な容量チェック・削除ロジック

---

### 6. ハードウェア追加 💰 **コスト増**

| 項目 | 標準構成案 | 確定仕様 | 追加コスト |
|------|----------|---------|----------|
| **WiFi拡張ボード** | なし | **必要** | 約5,000円 |
| **SDカード** | なし | **推奨** | 約1,000円 |

**合計追加コスト**: 約6,000円

---

## 📈 開発工数への影響

### Phase 1（MVP）

| 項目 | 標準構成案 | 確定仕様 | 増減 |
|------|----------|---------|------|
| **期間** | 3-5日 | **5-7日** | +2日 |
| **理由** | - | Full HD対応、動き検出追加 | - |

**Phase 1実装内容**:
- Full HD映像取得（HDR有効）
- H.264エンコード
- USB CDC通信
- 手動録画モード
- 動き検出（基本実装） ← **追加**
- シンプルなGUI

---

### Phase 2（WiFi + RTSP）

| 項目 | 標準構成案 | 確定仕様 | 増減 |
|------|----------|---------|------|
| **期間** | 2-3日 | **5-7日** | +3-4日 |
| **理由** | - | WiFi実装、RTSP実装、録画モード4種 | - |

**Phase 2実装内容**:
- WiFi通信実装
- RTSP Server（Spresense）← **新規**
- RTSP Client（PC）← **新規**
- 常時/動き検出/スケジュール録画 ← **追加**
- ストレージ自動管理
- タイムスタンプ重畳

---

### 合計工数

| Phase | 標準構成案 | 確定仕様 | 増減 |
|-------|----------|---------|------|
| Phase 1 | 3-5日 | 5-7日 | +2日 |
| Phase 2 | 2-3日 | 5-7日 | +3-4日 |
| **合計** | **5-8日** | **10-14日** | **+5-6日** |

**工数増加要因**:
1. Full HD対応（帯域幅、ストレージ最適化）
2. WiFi実装（設定、安定化）
3. RTSP実装（プロトコルスタック）
4. 動き検出（アルゴリズム、最適化）
5. 4種の録画モード（ロジック、UI）

---

## 🎯 推奨される対応

### Option A: 段階的実装（推奨）⭐

**Phase 1（簡易版）**: 5-7日
- HD (1280x720) ← **一時的にダウングレード**
- USB CDC
- H.264
- 手動録画のみ
- **動き検出なし** ← **Phase 2に延期**

**Phase 2（Full HD + WiFi）**: 5-7日
- Full HD (1920x1080) ← **アップグレード**
- WiFi + RTSP
- 全録画モード
- 動き検出

**メリット**:
- Phase 1を早く完了（プロトタイプ）
- 動作確認しながら段階的に拡張
- リスク分散

---

### Option B: 仕様通り実装

**Phase 1（Full機能）**: 7-10日
- Full HD
- USB CDC
- 手動録画
- 動き検出（基本）

**Phase 2（WiFi + 拡張）**: 7-10日
- WiFi + RTSP
- 全録画モード
- ストレージ管理

**メリット**:
- 要求仕様通りの実装
- Phase 1完了時点で実用的

**デメリット**:
- Phase 1が長い
- 初期プロトタイプまで時間がかかる

---

## 📋 技術的な懸念点と対策

### 懸念1: Full HDの帯域幅

**問題**:
- Full HD 30fps H.264: 3-6 Mbps
- USB CDC: 最大12 Mbps（実効9 Mbps程度）
- 余裕が少ない

**対策**:
- Phase 1はUSBでテスト
- ビットレート調整可能に（3/4/5/6 Mbps）
- フレームレート調整可能に（15/20/25/30 fps）
- Phase 2でWiFi移行（帯域幅十分）

---

### 懸念2: Spresense RAM制約（動き検出）

**問題**:
- Spresense RAM: 1.5MB
- Full HDバッファ: 1フレーム約6MB（YUV420）
- 動き検出用バッファ確保困難

**対策**:
- 縮小画像で動き検出（320x180等）
- ブロック単位処理（メモリ削減）
- 外部メモリ活用（必要なら）

---

### 懸念3: RTSP実装の複雑さ

**問題**:
- RTSPはステートフル（DESCRIBE, SETUP, PLAY等）
- RTP/RTCPパケット処理
- Spresense側の処理負荷

**対策**:
- 軽量RTSPライブラリ使用（live555の組み込み版等）
- Phase 1でUSB実装（RTSPなし）
- Phase 2でRTSP追加（段階的）

---

### 懸念4: WiFi安定性

**問題**:
- 電波状況による切断
- レイテンシ変動
- パケットロス

**対策**:
- 自動再接続機能
- バッファリング（0.5-1秒）
- エラー回復ロジック
- SDカードへのローカルバックアップ

---

## ✅ 次のアクション

### 1. ユーザー確認事項

以下の点について確認をお願いします:

1. **実装方式の選択**:
   - [ ] Option A: 段階的実装（Phase 1はHD、Phase 2でFull HD）
   - [ ] Option B: 仕様通り実装（Phase 1からFull HD）

2. **工数の了承**:
   - [ ] 10-14日の開発期間を了承
   - [ ] 段階的リリースを了承

3. **追加コストの了承**:
   - [ ] WiFi拡張ボード購入（約5,000円）
   - [ ] SDカード購入（約1,000円）
   - [ ] 推奨ストレージ増量（300GB以上）

---

### 2. 仕様書更新

確認後、以下を更新します:

1. ✅ REQUIREMENTS_FINAL.md（完了）
2. 📝 FUNCTIONAL_SPEC.md（WiFi/RTSP対応）
3. 📝 SOFTWARE_SPEC_SPRESENSE.md（WiFi/RTSP/動き検出）
4. 📝 SOFTWARE_SPEC_PC_RUST.md（RTSP Client）
5. 📝 PROTOCOL_SPEC.md（RTSP仕様）
6. 📝 IMPLEMENTATION_PROMPT.md（WiFi/RTSP対応）

---

### 3. 実装開始

仕様書更新後、Phase 1実装を開始します。

---

## 📞 質問・相談

変更内容について不明点や調整希望があれば、お知らせください。

特に以下の点について:
- 解像度をHDに戻す？（Phase 1の簡略化）
- 動き検出をPhase 2に延期？（Phase 1の簡略化）
- 予算・期間の制約

---

**文書作成日**: 2025-12-15
**バージョン**: 1.0
**ステータス**: ✋ **ユーザー確認待ち**
