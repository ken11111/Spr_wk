# Phase 3 実装計画

**作成日**: 2025-12-30
**前提**: Phase 1.5完了（VGAパイプライン、37.33 fps達成）、Phase 2完了（PC側MJPEGビューア）

---

## 📊 現状まとめ

### Phase 1 ～ Phase 2 の達成状況

| Phase | 内容 | 目標 | 実績 | 状態 |
|-------|------|------|------|------|
| **Phase 1** | Spresense QVGA実装 | 30 fps | - | ✅ 完了 |
| **Phase 1.5** | VGA パイプライン実装 | 12.5-13.2 fps | **37.33 fps** 🏆 | ✅ 完了 (2025-12-29) |
| **Phase 2** | PC側Rust MJPEG ビューア | - | ✅ 動作確認済み | ✅ 完了 (2025-12-22) |

### 主要な技術的成果

#### Spresense側 (Phase 1.5)
- **解像度**: VGA 640×480 JPEG
- **FPS**: 37.33 fps（複雑シーン）、32.0 fps（単純シーン）
- **アーキテクチャ**: マルチスレッドパイプライン
  - カメラスレッド (priority 110)
  - USBスレッド (priority 100)
  - 3バッファFIFOキュー
- **品質**: ゼロ警告、ゼロエラー、完全なエラーハンドリング

#### PC側 (Phase 2)
- **言語**: Rust
- **プロトコル**: MJPEG (CRC-16-CCITT)
- **機能**:
  - CLI受信アプリケーション
  - GUI リアルタイムビューア（実験的）
  - MJPEGストリーム保存
  - 個別JPEGファイル保存

---

## 🎯 Phase 3 の方向性（案）

Phase 1.5で当初のPhase 2.0目標（30 fps）を超過達成したため、Phase 3では以下の方向性を検討:

### オプション A: システム統合・安定性重視 ⭐ 推奨

**目的**: 実用的なセキュリティカメラシステムとして完成させる

#### タスク一覧

1. **PC側ビューアのVGA対応** (優先度: 高)
   - 現在: QVGA (320×240) 向け
   - 対応: VGA (640×480) への最適化
   - GUI表示性能の検証

2. **長時間動作の安定性検証** (優先度: 高)
   - 24時間連続動作テスト
   - メモリリーク検出
   - エラーリカバリの検証
   - 温度特性の確認

3. **録画・再生機能の実装** (優先度: 中)
   - PC側での録画開始/停止
   - タイムスタンプ埋め込み
   - 録画ファイルの管理
   - プレイバック機能

4. **システムドキュメント整備** (優先度: 中)
   - ユーザーマニュアル作成
   - セットアップガイド
   - トラブルシューティング拡充

5. **パフォーマンスチューニング** (優先度: 低)
   - JPEG品質の動的調整
   - バッファサイズの最適化
   - CPU使用率の削減

**期待成果**:
- 実用レベルのセキュリティカメラシステム
- 24時間安定動作
- 使いやすいGUIアプリケーション

**想定期間**: 2-3週間

---

### オプション B: 高解像度化

**目的**: より高画質な映像を実現

#### タスク一覧

1. **SVGA (800×600) 対応**
   - カメラドライバー設定変更
   - バッファサイズ調整
   - FPS測定（目標: 20+ fps）

2. **XGA (1024×768) 対応**
   - メモリ使用量の検証
   - USB帯域幅の確認
   - FPS測定（目標: 15+ fps）

3. **解像度切り替え機能**
   - VGA/SVGA/XGA の動的切り替え
   - 帯域幅に応じた自動調整

**懸念事項**:
- ⚠️ USB Full Speed (12 Mbps) の帯域制約
- ⚠️ SpresenseのRAM制約 (1.5 MB)
- ⚠️ 高解像度でのFPS低下の可能性

**想定期間**: 2-3週間

---

### オプション C: 機能拡張

**目的**: セキュリティカメラとしての機能を充実

#### タスク一覧

1. **動き検知** (Motion Detection)
   - フレーム差分検出
   - 検知時の通知機能
   - 検知エリアの設定

2. **顔検出** (Face Detection)
   - OpenCVベースの実装
   - リアルタイム検出
   - バウンディングボックス表示

3. **マルチカメラ対応**
   - 複数Spresenseデバイスの同時接続
   - カメラ切り替えUI
   - 同期録画

4. **ネットワーク配信**
   - MJPEGストリームのHTTP配信
   - WebRTC対応（検討）
   - リモートアクセス

**懸念事項**:
- ⚠️ Spresense側のCPU負荷増加
- ⚠️ FPSへの影響
- ⚠️ 実装の複雑さ

**想定期間**: 4-6週間

---

## 📋 推奨フェーズ: Phase 3.0 (システム統合)

**選択理由**:
1. ✅ Phase 1.5で既に高性能達成（37.33 fps）
2. ✅ 実用性を重視すべき段階
3. ✅ 安定性が最優先（長時間動作の実績が必要）
4. ✅ ユーザビリティの向上

### Phase 3.0 詳細手順

#### Step 1: PC側ビューアのVGA対応（優先度: 最高）

**現状**:
- Rust GUIビューアはQVGA (320×240) 向けに開発
- VGA (640×480) での動作未検証

**作業内容**:
1. GUIウィンドウサイズの調整
2. VGAフレームの表示性能テスト
3. バッファサイズの最適化
4. FPS表示の精度向上

**成功基準**:
- ✅ VGA 640×480 フレームのリアルタイム表示（30+ fps）
- ✅ CPU使用率 < 30%
- ✅ メモリ使用量 < 100 MB
- ✅ 表示遅延 < 100ms

**想定期間**: 2-3日

---

#### Step 2: VGA統合動作テスト（優先度: 高）

**作業内容**:
1. Spresense VGA 37fps + PC GUIビューアの統合テスト
2. エンドツーエンドのレイテンシ測定
3. ドロップフレームの検出
4. USB接続の安定性確認

**テストシナリオ**:
- ✅ 5分間の連続動作
- ✅ USB再接続テスト
- ✅ 高負荷シーン（複雑な映像）でのテスト
- ✅ 低負荷シーン（単純な映像）でのテスト

**成功基準**:
- ✅ ドロップフレーム率 < 1%
- ✅ エンドツーエンド遅延 < 200ms
- ✅ エラー率 = 0%

**想定期間**: 1-2日

---

#### Step 3: 録画機能の実装（優先度: 高）

**機能要件**:
1. **録画開始/停止**: GUIボタンでコントロール
2. **ファイル形式**:
   - MJPEGストリーム (.mjpeg)
   - または個別JPEG (.jpg)
3. **タイムスタンプ**: ファイル名に日時を埋め込み
4. **容量管理**: 最大ファイルサイズの設定

**実装詳細**:
```rust
// 録画状態の管理
enum RecordingState {
    Idle,
    Recording { start_time: Instant, frame_count: u32 },
}

// ファイル名生成
fn generate_filename() -> String {
    format!("recording_{}.mjpeg", chrono::Local::now().format("%Y%m%d_%H%M%S"))
}
```

**成功基準**:
- ✅ 録画開始/停止が正常に動作
- ✅ ファイルが正しく保存される
- ✅ タイムスタンプが正確
- ✅ ffplayまたはVLCで再生可能

**想定期間**: 2-3日

---

#### Step 4: 長時間動作テスト（優先度: 高）

**テスト内容**:
1. **24時間連続動作テスト**
   - Spresense側の安定性
   - PC側の安定性
   - メモリ使用量の推移

2. **性能モニタリング**
   - FPSの推移（30分毎に記録）
   - エラー発生回数
   - CPU温度（可能なら）
   - メモリ使用量

3. **ログ収集**
   - Spresense側のシリアルログ
   - PC側のアプリケーションログ
   - USB通信のエラーログ

**監視スクリプト例**:
```bash
#!/bin/bash
# 24時間テストスクリプト
LOG_FILE="24h_test_$(date +%Y%m%d_%H%M%S).log"

echo "Starting 24-hour stability test..." | tee -a $LOG_FILE
./target/release/security_camera_gui 2>&1 | while read line; do
    echo "[$(date +%H:%M:%S)] $line" | tee -a $LOG_FILE
done
```

**成功基準**:
- ✅ 24時間連続動作（クラッシュなし）
- ✅ FPS低下 < 5%
- ✅ メモリリークなし（使用量が一定）
- ✅ エラー率 < 0.1%

**想定期間**: 2日（テスト実行 + 分析）

---

#### Step 5: ドキュメント整備（優先度: 中）

**作成ドキュメント**:

1. **ユーザーマニュアル** (`USER_MANUAL.md`)
   - システム概要
   - セットアップ手順（Spresense + PC）
   - 基本的な使い方
   - GUIの操作方法
   - 録画・再生方法

2. **トラブルシューティングガイド** (`TROUBLESHOOTING.md`)
   - よくある問題と解決策
   - エラーメッセージ一覧
   - USB接続問題の対処法
   - 性能問題のデバッグ方法

3. **開発者ガイド** (`DEVELOPER_GUIDE.md`)
   - アーキテクチャ概要
   - Spresense側のビルド方法
   - PC側のビルド方法
   - プロトコル仕様
   - 拡張方法

4. **性能ベンチマークレポート** (`PERFORMANCE_REPORT.md`)
   - Phase 1.5のベンチマーク結果
   - エンドツーエンドの性能測定
   - 24時間テスト結果
   - 推奨動作環境

**想定期間**: 3-4日

---

## 📊 Phase 3.0 タイムライン

| Week | Step | 内容 | 成果物 |
|------|------|------|--------|
| **Week 1** | Step 1 | PC側ビューアVGA対応 | ✅ VGA対応GUIビューア |
| | Step 2 | VGA統合動作テスト | ✅ 統合テストレポート |
| **Week 2** | Step 3 | 録画機能実装 | ✅ 録画機能付きビューア |
| | Step 4開始 | 24時間テスト開始 | （テスト実行中） |
| **Week 3** | Step 4完了 | テスト分析・改善 | ✅ 安定性レポート |
| | Step 5 | ドキュメント整備 | ✅ 完全なドキュメントセット |

**合計期間**: 約3週間

---

## ✅ Phase 3.0 完了条件

### 必須条件

- [ ] PC側GUIビューアがVGA 640×480 をリアルタイム表示（30+ fps）
- [ ] 録画機能が正常に動作（開始/停止/保存）
- [ ] 24時間連続動作テストをパス（クラッシュなし、FPS安定）
- [ ] メモリリークがないことを確認
- [ ] エラー率 < 0.1%
- [ ] ユーザーマニュアル完成
- [ ] トラブルシューティングガイド完成

### オプション条件

- [ ] CPU使用率 < 20%（PC側）
- [ ] エンドツーエンド遅延 < 150ms
- [ ] 複数のOSでの動作確認（Linux, Windows, macOS）
- [ ] 開発者ガイド完成
- [ ] 自動テストスイート作成

---

## 🔄 Phase 3.0 → Phase 4 への展望

Phase 3.0完了後の次のステップ候補:

### Phase 4 候補A: 高解像度化
- SVGA (800×600) 対応
- XGA (1024×768) 対応
- 解像度切り替え機能

### Phase 4 候補B: 高度な機能
- 動き検知 (Motion Detection)
- 顔検出 (Face Detection)
- ネットワーク配信 (MJPEG over HTTP)

### Phase 4 候補C: マルチカメラシステム
- 複数Spresenseの同時接続
- カメラ切り替えUI
- 同期録画・再生

**決定時期**: Phase 3.0 完了時（約3週間後）

---

## 📝 次のアクション

### 即座に実施すべきこと

1. **Phase 3.0の承認**
   - このプランでOKか確認
   - オプションA/B/Cから選択（推奨: オプションA）

2. **環境準備**
   - Rust開発環境の確認
   - Spresense VGAファームウェアの準備
   - テスト用PCの準備

3. **Step 1開始**
   - PC側ビューアのVGA対応実装開始

### 確認事項

- [ ] Phase 3.0の方向性でOKか？
- [ ] タイムライン（3週間）は妥当か？
- [ ] 優先度の変更が必要か？
- [ ] 追加すべきタスクはあるか？

---

**作成者**: Claude Code (Sonnet 4.5)
**バージョン**: 1.0
**ステータス**: 📋 提案・レビュー待ち
