# ä½¿ç”¨é‡åˆ¶é™æ™‚ã®å‹•ä½œä»•æ§˜

## æ¦‚è¦

Claude Codeä½¿ç”¨é‡åˆ¶é™åˆ°é”æ™‚ã®ä¸­æ–­å‡¦ç†ã¨ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ã®è©³ç´°ä»•æ§˜ã§ã™ã€‚

## ğŸ”„ æ”¹å–„ã•ã‚ŒãŸå‹•ä½œãƒ•ãƒ­ãƒ¼

### v1 (å¾“æ¥ç‰ˆ) ã®å•é¡Œ

```
ä½¿ç”¨é‡åˆ¶é™åˆ°é”
â†“
âŒ ã‚¿ã‚¹ã‚¯ã‚’ã€Œå¤±æ•—ã€ã¨ã—ã¦è¨˜éŒ²
â†“
âŒ æ¬¡å›ã‚‚å®Ÿè¡Œã•ã‚Œãªã„
â†“
âŒ æ‰‹å‹•ã§å†å®Ÿè¡ŒãŒå¿…è¦
```

### v2 (æ”¹å–„ç‰ˆ) ã®å‹•ä½œ

```
ä½¿ç”¨é‡åˆ¶é™åˆ°é”
â†“
â¸ï¸  ã‚¿ã‚¹ã‚¯ã‚’ã€Œä¿ç•™ã€çŠ¶æ…‹ã«
â†“
quota_exceeded.log ã«è¨˜éŒ²
â†“
âœ… æ¬¡å›ã®è‡ªå‹•å®Ÿè¡Œæ™‚ã«è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
â†“
ä½¿ç”¨é‡å›å¾©å¾Œã€è‡ªå‹•çš„ã«å®Ÿè¡Œã•ã‚Œã‚‹
```

## ğŸ“Š çµ‚äº†ã‚³ãƒ¼ãƒ‰ã®å®šç¾©

| ã‚³ãƒ¼ãƒ‰ | æ„å‘³ | å‹•ä½œ |
|--------|------|------|
| 0 | æ­£å¸¸çµ‚äº† | ã‚¿ã‚¹ã‚¯å®Œäº†ã€æ¬¡ã®ã‚¿ã‚¹ã‚¯ã¸ |
| 1 | ä¸€èˆ¬ã‚¨ãƒ©ãƒ¼ | ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆ+1ã€å†å®Ÿè¡Œ |
| 2 | **ä½¿ç”¨é‡åˆ¶é™** | **ä¿ç•™æ‰±ã„ã€è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤** |
| 3 | ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ | ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå®Ÿè¡Œã—ãªã„ï¼‰ |

## ğŸ¯ ä½¿ç”¨é‡åˆ¶é™æ™‚ã®è©³ç´°å‹•ä½œ

### ã‚±ãƒ¼ã‚¹1: å®Ÿè¡Œå‰ã«åˆ¶é™åˆ°é”

```bash
./queue_manager_v2.sh run

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš€ ã‚¿ã‚¹ã‚¯å®Ÿè¡Œé–‹å§‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ID: 10
ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: AIæŠ€è¡“ã®æœ€æ–°å‹•å‘ã‚’èª¿æŸ»...

ğŸ“Š ä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯
ä»Šæ—¥ã®å®Ÿè¡Œå›æ•°: 100 / 100
âŒ 1æ—¥ã®å®Ÿè¡Œå›æ•°åˆ¶é™ã«é”ã—ã¾ã—ãŸ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â¸ï¸  ä½¿ç”¨é‡åˆ¶é™åˆ°é” - ã‚¿ã‚¹ã‚¯ã‚’ä¿ç•™
æ¬¡å›ã®è‡ªå‹•å®Ÿè¡Œæ™‚ã«å†è©¦è¡Œã•ã‚Œã¾ã™
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[è¨˜éŒ²]
- quota_exceeded.log ã«è¿½åŠ 
- executed.log ã«ã¯è¨˜éŒ²ã—ãªã„ â† é‡è¦ï¼
- retry_count ã¯å¢—ãˆãªã„
- status ã¯ pending ã®ã¾ã¾
```

### ã‚±ãƒ¼ã‚¹2: å®Ÿè¡Œä¸­ã«åˆ¶é™åˆ°é”ï¼ˆéƒ¨åˆ†å®Ÿè¡Œï¼‰

```bash
å®Ÿè¡Œé–‹å§‹
â†“
é€”ä¸­ã§åˆ¶é™åˆ°é”
â†“
éƒ¨åˆ†çš„ãªå‡ºåŠ›ãŒä¿å­˜ã•ã‚Œã‚‹
â†“
çµ‚äº†ã‚³ãƒ¼ãƒ‰ 2 ã‚’è¿”ã™
â†“
â¸ï¸  ä¿ç•™æ‰±ã„
â†“
æ¬¡å›ã€æœ€åˆã‹ã‚‰å†å®Ÿè¡Œ
```

**é‡è¦**: éƒ¨åˆ†å®Ÿè¡Œã•ã‚ŒãŸå†…å®¹ã¯ç ´æ£„ã•ã‚Œã€æ¬¡å›ã¯æœ€åˆã‹ã‚‰å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

## ğŸ“‹ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†

### executed.logï¼ˆæ­£å¸¸å®Œäº†ã®ã¿ï¼‰
```
1,2025-12-14 10:30:00,45,0,SDKãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„
```
- æ­£å¸¸çµ‚äº†ã—ãŸã‚¿ã‚¹ã‚¯ã®ã¿è¨˜éŒ²
- **ä½¿ç”¨é‡åˆ¶é™ã§ä¸­æ–­ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã¯è¨˜éŒ²ã—ãªã„**

### quota_exceeded.logï¼ˆä½¿ç”¨é‡åˆ¶é™å±¥æ­´ï¼‰
```
10,2025-12-14 15:30:00,2,quota_exceeded,AIæŠ€è¡“ã®æœ€æ–°å‹•å‘ã‚’èª¿æŸ»...
10,2025-12-14 16:00:00,1,quota_exceeded,AIæŠ€è¡“ã®æœ€æ–°å‹•å‘ã‚’èª¿æŸ»...
10,2025-12-14 20:00:00,45,0,AIæŠ€è¡“ã®æœ€æ–°å‹•å‘ã‚’èª¿æŸ»...  â† æœ€çµ‚çš„ã«æˆåŠŸ
```
- ä½¿ç”¨é‡åˆ¶é™ã§ä¸­æ–­ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚’è¨˜éŒ²
- ä½•å›ä¸­æ–­ã•ã‚ŒãŸã‹ã‚’è¿½è·¡

### retry_tasks.logï¼ˆãƒªãƒˆãƒ©ã‚¤å±¥æ­´ï¼‰
```
5,2025-12-14 10:00:00,30,1,1,3,PATENT_ANALYSIS.mdã‚’èª­ã‚“ã§è¦ç´„...
5,2025-12-14 10:30:00,35,1,2,3,PATENT_ANALYSIS.mdã‚’èª­ã‚“ã§è¦ç´„...
5,2025-12-14 11:00:00,40,0,3,3,PATENT_ANALYSIS.mdã‚’èª­ã‚“ã§è¦ç´„...  â† æˆåŠŸ
```
- å½¢å¼: `ID,æ™‚åˆ»,å®Ÿè¡Œæ™‚é–“,çµ‚äº†ã‚³ãƒ¼ãƒ‰,ãƒªãƒˆãƒ©ã‚¤å›æ•°,æœ€å¤§ãƒªãƒˆãƒ©ã‚¤æ•°,ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ`
- ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹ãƒªãƒˆãƒ©ã‚¤ã‚’è¿½è·¡

## ğŸ”„ ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹

### CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆæ–°è¦ã‚«ãƒ©ãƒ ï¼‰

```csv
id,...,retry_count,max_retries
1,...,0,3              # é€šå¸¸ã‚¿ã‚¹ã‚¯ï¼ˆæœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
10,...,0,5             # ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ï¼ˆæœ€å¤§5å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
```

### ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆã®æ›´æ–°

**ä¸€èˆ¬ã‚¨ãƒ©ãƒ¼æ™‚**:
```
retry_count: 0 â†’ 1 â†’ 2 â†’ 3
             â†“    â†“    â†“    â†“
             å®Ÿè¡Œ  å®Ÿè¡Œ  å®Ÿè¡Œ  ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¸Šé™ï¼‰
```

**ä½¿ç”¨é‡åˆ¶é™æ™‚**:
```
retry_count: 0 â†’ 0 â†’ 0 â†’ 0
             â†“    â†“    â†“    â†“
             ä¿ç•™  ä¿ç•™  ä¿ç•™  æœ€çµ‚çš„ã«æˆåŠŸ
```
- **ä½¿ç”¨é‡åˆ¶é™ã§ã¯retry_countã‚’å¢—ã‚„ã•ãªã„**
- ä½•åº¦ã§ã‚‚è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤

## ğŸ’¡ å®Ÿç”¨ã‚·ãƒŠãƒªã‚ª

### ã‚·ãƒŠãƒªã‚ª1: å¤œé–“ãƒãƒƒãƒå‡¦ç†

```csv
# å¤œ22æ™‚ã«å®Ÿè¡Œé–‹å§‹
100,high,/home/ken/Spr_ws,"ã‚¿ã‚¹ã‚¯1",pending,2025-12-14 22:00,,no,,0,3
101,high,/home/ken/Spr_ws,"ã‚¿ã‚¹ã‚¯2",pending,2025-12-14 22:00,,no,,0,3
102,high,/home/ken/Spr_ws,"ã‚¿ã‚¹ã‚¯3",pending,2025-12-14 22:00,,no,,0,3
```

**22:00**: ã‚¿ã‚¹ã‚¯100å®Ÿè¡Œ â†’ æˆåŠŸ
**22:30**: ã‚¿ã‚¹ã‚¯101å®Ÿè¡Œ â†’ ä½¿ç”¨é‡åˆ¶é™åˆ°é”
**22:30**: ã‚¿ã‚¹ã‚¯102ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä½¿ç”¨é‡åˆ¶é™ä¸­ï¼‰
**ç¿Œæ—¥00:00**: ä½¿ç”¨é‡ãƒªã‚»ãƒƒãƒˆ
**00:30**: ã‚¿ã‚¹ã‚¯101è‡ªå‹•å†å®Ÿè¡Œ â†’ æˆåŠŸ
**01:00**: ã‚¿ã‚¹ã‚¯102è‡ªå‹•å®Ÿè¡Œ â†’ æˆåŠŸ

### ã‚·ãƒŠãƒªã‚ª2: ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯

```csv
id,priority,working_dir,prompt,status,scheduled_time,dependencies,repeat,repeat_interval,retry_count,max_retries
200,high,/home/ken/Spr_ws,"AIå‹•å‘èª¿æŸ»",pending,,,yes,daily,0,5
```

**12/14 09:00**: å®Ÿè¡Œ â†’ æˆåŠŸ
**12/15 09:00**: å®Ÿè¡Œ â†’ ä½¿ç”¨é‡åˆ¶é™
**12/15 10:00**: è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ â†’ ä½¿ç”¨é‡åˆ¶é™
**12/15 14:00**: è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ â†’ æˆåŠŸ
**12/16 09:00**: æ¬¡å›å®Ÿè¡Œï¼ˆå®šæœŸå®Ÿè¡Œç¶™ç¶šï¼‰

## ğŸ“Œ é‡è¦ãªä»•æ§˜

### 1. ä½¿ç”¨é‡åˆ¶é™ã¯ã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„

- âŒ ã‚¨ãƒ©ãƒ¼æ‰±ã„ã—ãªã„
- âœ… ä¸€æ™‚çš„ãªã€Œä¿ç•™ã€çŠ¶æ…‹
- âœ… è‡ªå‹•çš„ã«å†è©¦è¡Œã•ã‚Œã‚‹

### 2. æ¬¡ã®ã‚¿ã‚¹ã‚¯ã¸ã®å½±éŸ¿

**v1ã®å•é¡Œ**:
```
ã‚¿ã‚¹ã‚¯A â†’ ä½¿ç”¨é‡åˆ¶é™
â†“
ã‚¿ã‚¹ã‚¯Bã‚‚å®Ÿè¡Œã•ã‚Œãªã„ï¼ˆåˆ¶é™ãŒç¶šã„ã¦ã„ã‚‹ãŸã‚ï¼‰
â†“
æ‰‹å‹•ä»‹å…¥ãŒå¿…è¦
```

**v2ã®æ”¹å–„**:
```
ã‚¿ã‚¹ã‚¯A â†’ ä½¿ç”¨é‡åˆ¶é™ â†’ ä¿ç•™
â†“
æ¬¡å›å®Ÿè¡Œæ™‚ã€ã¾ãšã‚¿ã‚¹ã‚¯Aã‚’å†è©¦è¡Œ
â†“
æˆåŠŸã—ãŸã‚‰ã‚¿ã‚¹ã‚¯Bã¸
â†“
å¤±æ•—ã—ãŸã‚‰æ¬¡å›ã¾ãŸå†è©¦è¡Œ
```

### 3. ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ã®æ‰±ã„

```
ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ãŒä½¿ç”¨é‡åˆ¶é™ã§ä¸­æ–­
â†“
æ¬¡å›å®Ÿè¡Œæ™‚åˆ»ã¾ã§ã«æˆåŠŸã™ã‚Œã°OK
â†“
æ¬¡å›å®Ÿè¡Œæ™‚åˆ»ã‚’éãã¦ã‚‚æœªå®Œäº†ã®å ´åˆ
â†“
å®Œäº†å¾Œã€æ¬¡ã®å®šæœŸå®Ÿè¡Œã¾ã§å¾…æ©Ÿ
```

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q1: ã‚¿ã‚¹ã‚¯ãŒä½•åº¦ã‚‚ä¿ç•™ã•ã‚Œã‚‹

**åŸå› **: ä½¿ç”¨é‡åˆ¶é™ãŒç¶™ç¶šã—ã¦ã„ã‚‹
**å¯¾ç­–**:
```bash
# ä½¿ç”¨é‡ã‚’ç¢ºèª
./check_usage.sh

# åˆ¶é™ã‚’èª¿æ•´
nano check_usage.sh
# MAX_REQUESTS_PER_DAY ã‚’å¢—ã‚„ã™
```

### Q2: ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ã«é”ã—ãŸã‚¿ã‚¹ã‚¯

**ç¢ºèª**:
```bash
./queue_manager_v2.sh status

# retry_tasks.log ã‚’ç¢ºèª
cat state/retry_tasks.log | grep "^ã‚¿ã‚¹ã‚¯ID,"
```

**å¯¾å‡¦**:
```bash
# CSVã®retry_countã‚’0ã«ãƒªã‚»ãƒƒãƒˆ
nano prompts.csv
# retry_countåˆ—ã‚’ 0 ã«å¤‰æ›´

# ã¾ãŸã¯ã€max_retriesã‚’å¢—ã‚„ã™
```

### Q3: ä¿ç•™ä¸­ã®ã‚¿ã‚¹ã‚¯ã‚’å¼·åˆ¶å®Ÿè¡Œ

```bash
# quota_exceeded.log ã‚’ã‚¯ãƒªã‚¢
rm state/quota_exceeded.log
touch state/quota_exceeded.log

# æ‰‹å‹•ã§å®Ÿè¡Œ
./queue_manager_v2.sh run
```

## ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º

```bash
./queue_manager_v2.sh status

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š Claude Code ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç·ã‚¿ã‚¹ã‚¯æ•°: 10
  é€šå¸¸ã‚¿ã‚¹ã‚¯: 7
  ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯: 3
å®Ÿè¡Œæ¸ˆã¿ï¼ˆé€šå¸¸ï¼‰: 3
ä½¿ç”¨é‡åˆ¶é™ã«ã‚ˆã‚‹ä¿ç•™: 2  â† NEW
ãƒªãƒˆãƒ©ã‚¤ä¸­: 1              â† NEW

ã€ä½¿ç”¨é‡åˆ¶é™ã«ã‚ˆã‚Šä¿ç•™ä¸­ã®ã‚¿ã‚¹ã‚¯ã€‘
  â¸ï¸  ID:10 - AIæŠ€è¡“ã®æœ€æ–°å‹•å‘ã‚’èª¿æŸ»... (2025-12-14 15:30:00)
  â¸ï¸  ID:11 - çµ„ã¿è¾¼ã¿é–‹ç™ºã®æœ€æ–°æŠ€è¡“ã‚’ãƒªã‚µãƒ¼ãƒ... (2025-12-14 15:35:00)
```

## ğŸ”§ ç§»è¡Œæ–¹æ³•

### v1ã‹ã‚‰v2ã¸ã®ç§»è¡Œ

```bash
# 1. ç¾åœ¨ã®ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
cp prompts.csv prompts.csv.backup
cp -r state state.backup

# 2. v2ã‚’ä½¿ç”¨é–‹å§‹
mv queue_manager_v2.sh queue_manager.sh

# 3. CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ›´æ–°ï¼ˆretry_count, max_retriesã‚«ãƒ©ãƒ è¿½åŠ ï¼‰
# prompts.csvã‚’ç·¨é›†ã—ã¦2åˆ—è¿½åŠ 

# 4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
./queue_manager.sh status
./queue_manager.sh run
```

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
cp prompts.csv.backup prompts.csv
cp -r state.backup state
```

## ğŸ“ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. max_retriesã®è¨­å®š

```csv
# é‡è¦ãªã‚¿ã‚¹ã‚¯: å¤šã‚ã«è¨­å®š
1,high,...,5,10   # æœ€å¤§10å›ãƒªãƒˆãƒ©ã‚¤

# é€šå¸¸ã‚¿ã‚¹ã‚¯: æ¨™æº–è¨­å®š
2,medium,...,0,3  # æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤

# ãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯: å°‘ãªã‚
3,low,...,0,1     # æœ€å¤§1å›ãƒªãƒˆãƒ©ã‚¤
```

### 2. ä½¿ç”¨é‡åˆ¶é™ã®ç›£è¦–

```bash
# å®šæœŸçš„ã«ä½¿ç”¨çŠ¶æ³ã‚’ç¢ºèª
*/30 * * * * ~/Spr_ws/claude_queue/check_usage.sh >> ~/usage.log 2>&1
```

### 3. ãƒ­ã‚°ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

```bash
# é€±æ¬¡ã§ãƒ­ã‚°ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
0 0 * * 0 cd ~/Spr_ws/claude_queue/state && tar -czf logs_$(date +\%Y\%m\%d).tar.gz *.log && rm *.log && touch executed.log repeat_tasks.log quota_exceeded.log retry_tasks.log
```

---

**ä½œæˆæ—¥**: 2025-12-14
**å¯¾è±¡**: Claude Codeè‡ªå‹•å®Ÿè¡Œã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  v2
**ç›®çš„**: ä½¿ç”¨é‡åˆ¶é™æ™‚ã®é©åˆ‡ãªå‡¦ç†ã¨è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
