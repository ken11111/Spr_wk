# Spresense HDRカメラ防犯カメラシステム - 要求仕様書（ドラフト）

## 📋 ドキュメント情報

- **作成日**: 2025-12-14
- **バージョン**: 0.1 (ドラフト)
- **ステータス**: **要確認事項あり**
- **目的**: ユーザー要求の明確化とシステム仕様策定

---

## 1. システム概要

### 1.1 システムの目的

Spresense HDRカメラボードを使用した防犯カメラシステムを構築する。

**主要機能**:
- ✅ リアルタイム映像配信（Spresense → PC）
- ✅ 映像録画とPC側への保存
- ✅ Rust実装によるPC側ソフトウェア

### 1.2 システム構成（暫定）

```
┌─────────────────────┐         ┌─────────────────────┐
│  Spresense          │         │  PC (Rust)          │
│  + HDR Camera       │ ◄─────► │  + 映像受信         │
│                     │  WiFi/  │  + 録画保存         │
│  - 映像取得         │  USB    │  - ストレージ管理   │
│  - 圧縮・送信       │         │  - 表示（Optional）│
└─────────────────────┘         └─────────────────────┘
```

---

## 2. 機能要求（ドラフト）

### 2.1 映像取得（Spresense側）

**確定事項**:
- ✅ HDRカメラボード使用

**要確認事項**:

#### Q1: 映像解像度・フレームレート 🔴 **要確認**

以下のどれを優先しますか？

| オプション | 解像度 | FPS | 用途 |
|-----------|--------|-----|------|
| A. 高画質 | 1920x1080 (Full HD) | 15-30 fps | 詳細な記録重視 |
| B. 標準画質 | 1280x720 (HD) | 30 fps | バランス型 |
| C. 低画質・高速 | 640x480 (VGA) | 60 fps | 動き検出重視 |
| D. カスタム | **要指定** | **要指定** | - |

**質問**:
- 希望する解像度は？
- 希望するフレームレートは？
- 画質と通信帯域のバランスは？

**回答**
- A

#### Q2: HDR機能の使用 🔴 **要確認**

**質問**:
- HDR機能を有効にしますか？
  - [x] はい（明暗差の大きい環境向け）
  - [ ] いいえ（通常のカメラとして使用）
- HDRによる処理遅延は許容できますか？
  - いいえ、最大限遅延は抑えてください

#### Q3: 映像圧縮方式 🔴 **要確認**

以下のどの方式を使用しますか？

| 方式 | メリット | デメリット | Spresense対応 |
|------|---------|-----------|--------------|
| JPEG | 実装簡単、対応広い | 連続フレームで効率悪い | ✅ 標準対応 |
| H.264 | 高圧縮率、標準的 | エンコード負荷高い | ✅ ハードウェア対応 |
| H.265/HEVC | 超高圧縮率 | 処理負荷非常に高い | ❌ 非対応 |
| RAW転送 | 無圧縮、高品質 | 帯域幅大 | ✅ 可能 |

**質問**:
- 圧縮方式の希望は？
- ビットレート/品質の目標は？
- リアルタイム性と録画品質のどちらを優先？

**回答**
- H.264の方式にしてください

---

### 2.2 通信方式

#### Q4: 通信インターフェース 🔴 **要確認**

以下のどれを使用しますか？

| 方式 | 帯域幅 | メリット | デメリット |
|------|--------|---------|-----------|
| **USB CDC** | ~12 Mbps | 安定、簡単 | ケーブル必要 |
| **WiFi (TCP/IP)** | ~数十Mbps | 無線、柔軟 | 設定複雑、遅延 |
| **Ethernet (拡張)** | ~100 Mbps | 高速、安定 | 拡張ボード必要 |

**質問**:
- Spresense設置場所は？（PCとの距離）
- 有線/無線どちらを希望？
- WiFiを使う場合、アクセスポイントは用意済み？


**回答**
- 最終的にはWiFi、テストのために最初はUSB接続から始める

#### Q5: 通信プロトコル 🔴 **要確認**

以下のどれを使用しますか？

| プロトコル | 用途 | メリット |
|-----------|------|---------|
| **カスタムバイナリ** | 専用システム | 最小オーバーヘッド |
| **RTSP** | 標準ストリーミング | 既存ツール利用可 |
| **WebSocket** | Web統合 | ブラウザ対応 |
| **gRPC** | 高性能RPC | 型安全、効率的 |

**質問**:
- 既存の標準プロトコルを使う？
- それともシンプルなカスタムプロトコル？
- 将来的にWebブラウザからアクセスする可能性は？

**回答**
- RTSPでお願いします。

---

### 2.3 録画機能（PC側）

#### Q6: 録画トリガー 🔴 **要確認**

いつ録画を開始/停止しますか？

| モード | 説明 | 用途 |
|--------|------|------|
| **常時録画** | 起動から終了まで録画 | 24時間監視 |
| **手動録画** | ユーザーが開始/停止 | イベント時のみ |
| **動き検出** | 動きを検出したら録画 | 省ストレージ |
| **スケジュール** | 指定時間帯のみ録画 | 夜間のみ等 |

**質問**:
- 録画モードの希望は？
- 動き検出が必要な場合、どこで検出？（Spresense/PC）
- 録画前のバッファは必要？（動き検出前数秒も記録）


**回答**
- 最初は手動で、その後設定ですべてのモードに対応してほしい

#### Q7: ファイル保存形式 🔴 **要確認**

どの形式で保存しますか？

| 形式 | メリット | デメリット |
|------|---------|-----------|
| **MP4** | 標準的、再生簡単 | メタデータ必要 |
| **MKV** | 柔軟、ストリーミング向き | やや複雑 |
| **連番JPEG** | シンプル | 非効率、管理複雑 |
| **カスタム形式** | 最適化可能 | 専用プレーヤー必要 |

**質問**:
- 保存形式の希望は？
- 標準的なメディアプレーヤーで再生したい？
- タイムスタンプ等のメタデータは必要？


**回答**
- MP4

#### Q8: ストレージ管理 🔴 **要確認**

ストレージ容量管理をどうしますか？

| 方式 | 説明 |
|------|------|
| **固定期間保存** | 例: 7日分保存、古いものを削除 |
| **容量制限** | 例: 100GB上限、古いものを削除 |
| **手動管理** | ユーザーが手動で削除 |
| **無制限** | 削除しない（容量注意） |

**質問**:
- 保存期間の希望は？（1日/1週間/1ヶ月）
- ストレージ容量の上限は？
- 自動削除（ローテーション）は必要？


**回答**
- 容量制限、設定変更で変えられるようにしてください。

#### Q9: ファイル分割 🔴 **要確認**

録画ファイルをどう分割しますか？

| 方式 | 例 |
|------|-----|
| **時間分割** | 例: 1時間ごとに新ファイル |
| **サイズ分割** | 例: 1GBごとに新ファイル |
| **イベント分割** | 動き検出ごとに新ファイル |
| **分割なし** | 1つの大きなファイル |

**質問**:
- ファイル分割の希望は？
- 分割する場合、間隔/サイズは？

**回答**
- 時間分割、設定変更できるようにしてほしい

---

### 2.4 表示機能（PC側）

#### Q10: リアルタイム表示 🔴 **要確認**

リアルタイム映像表示は必要ですか？

**質問**:
- [x] はい、GUIで表示したい(優先度：低)
  - どのGUIフレームワーク？（egui, iced, gtk-rs 等）
  - 複数カメラ同時表示は必要？
- [ ] はい、コンソールでASCIIアート表示
- [ ] いいえ、録画のみで良い

#### Q11: 再生機能 🔴 **要確認**

録画済み映像の再生機能は必要ですか？

**質問**:
- [x] はい、アプリ内で再生したい(優先度：低)
- [ ] いいえ、外部プレーヤー（VLC等）で再生

---

### 2.5 追加機能

#### Q12: 動き検出 🔴 **要確認**

動き検出機能は必要ですか？

**質問**:
- [x] はい、必要
  - 検出場所: [x] Spresense側  [ ] PC側
  - 検出感度の調整機能は必要？
  - 検出時の通知は必要？（音/メール等）
- [ ] いいえ、不要

#### Q13: 複数カメラ対応 🔴 **要確認**

将来的に複数カメラを接続する予定はありますか？

**質問**:
- [ ] はい、予定あり（台数: **要指定**）
- [x] いいえ、1台のみ

#### Q14: タイムスタンプ・OSD 🔴 **要確認**

映像にタイムスタンプ等を重畳表示しますか？

**質問**:
- [x] はい、日時を表示
- [ ] はい、日時＋カメラID等も表示
- [ ] いいえ、不要

#### Q15: 通知機能 🔴 **要確認**

イベント発生時の通知は必要ですか？

**質問**:
- [ ] はい、必要
  - 通知方法: [ ] デスクトップ通知  [ ] メール  [ ] LINE等
  - 通知条件: [ ] 動き検出  [ ] 録画開始/停止  [ ] エラー
- [x] いいえ、不要

---

## 3. 非機能要求

### 3.1 パフォーマンス要求

#### Q16: 許容遅延 🔴 **要確認**

映像の遅延はどの程度許容できますか？

| 遅延 | 用途 |
|------|------|
| <100ms | リアルタイム監視 |
| <1s | 一般的な監視 |
| <5s | 録画メイン |

**質問**: 許容遅延は？

**回答**: 1sがMust、100msはWant

#### Q17: 録画の信頼性 🔴 **要確認**

フレームドロップは許容できますか？

**質問**:
- [ ] 完全録画必須（フレームドロップNG）
- [x] 多少のドロップは許容（ネットワーク状況次第）

### 3.2 運用要求

#### Q18: 起動モード 🔴 **要確認**

システムの起動方法は？

**質問**:
- Spresense: [x] 電源投入で自動起動  [ ] 手動起動
- PC: [ ] OS起動で自動起動  [x] 手動起動

#### Q19: エラー回復 🔴 **要確認**

通信断等のエラー時の動作は？

**質問**:
- [x] 自動再接続を試みる
- [x] エラーログ記録
- [ ] ユーザーに通知

---

## 4. ハードウェア構成

### 4.1 Spresense側

**確定事項**:
- Spresense メインボード
- HDRカメラボード

**要確認事項**:

#### Q20: Spresense拡張ボード 🔴 **要確認**

追加ボードは必要ですか？

| ボード | 用途 | 必要性 |
|--------|------|--------|
| WiFi拡張ボード | 無線通信 | WiFi使用時必須 |
| Ethernet拡張 | 有線LAN | 高速通信時推奨 |
| SDカード | ローカルバックアップ | Optional |

**質問**: 使用する拡張ボードは？

**回答**: WiFi拡張、SDカード

### 4.2 PC側

#### Q21: PC環境 🔴 **要確認**

開発・運用環境は？

**質問**:
- OS: [x] Windows  [x] Linux  [ ] macOS  [x] 複数対応
- CPU/メモリ: 最小スペックは？
- ストレージ: HDD/SSD、容量は？

**回答**:メモリ8G、HDD:3GB以上

---

## 5. 開発スコープ

### 5.1 Phase 1（MVP - Minimum Viable Product）

**必須機能** - 最初に実装する最小機能:

1. ✅ 映像取得（Spresense）
2. ✅ 映像送信（USB経由）
3. ✅ 映像受信（PC/Rust）
4. ✅ ファイル保存（基本）

### 5.2 Phase 2（拡張機能）

**オプション機能** - 後から追加:

- 動き検出
- リアルタイム表示
- 複数カメラ対応
- Web UI
- 通知機能

#### Q22: Phase分け 🔴 **要確認**

どこまでを初期実装しますか？

**質問**:
- Phase 1で実装する機能は？
- Phase 2以降に回せる機能は？

---

## 6. システム制約

### 6.1 技術的制約

**Spresense制約**:
- CPU: CXD5602 (ARM Cortex-M4F × 6コア)
- メモリ: 1.5MB RAM
- ストレージ: 8MB Flash
- カメラ: 最大5MP、JPEG/YUVサポート

**通信制約**:
- USB: 最大12Mbps (Full Speed)
- WiFi: 802.11 b/g/n (理論値最大150Mbps)

### 6.2 ソフトウェア制約

**Spresense側**:
- OS: NuttX RTOS
- 言語: C/C++
- SDK: Spresense SDK

**PC側**:
- 言語: Rust（確定）
- 最小サポートRustバージョン: **要確認**

#### Q23: Rustクレート選定 🔴 **要確認**

使用するRustクレートの希望は？

**候補**:
- 映像処理: `ffmpeg`, `gstreamer`, `opencv-rust`
- 通信: `tokio`, `async-std`, `serialport-rs`
- GUI: `egui`, `iced`, `gtk-rs`, `druid`

**質問**: 特定のクレートを使いたい？

**回答**:　Rustの知識がなく回答不可、別途解説要望

---

## 7. セキュリティ要求

#### Q24: セキュリティ要件 🔴 **要確認**

セキュリティは必要ですか？

**質問**:
- [ ] 映像の暗号化が必要
- [ ] 認証機能が必要
- [ ] アクセス制御が必要
- [x] 不要（ローカルネットワーク内のみ）

---

## 8. テスト・検証要求

#### Q25: テスト環境 🔴 **要確認**

どのような環境でテストしますか？

**質問**:
- 設置場所: [] 屋内  [ ] 屋外  [x] 両方
- 照明条件: [ ] 明るい  [ ] 暗い  [x] 変動大
- 温度範囲: **-5℃～50℃**
- 動作時間: [ ] 短時間  [x] 24時間連続

---

## 9. まとめ - 確認事項一覧

### 🔴 最優先で確認が必要な項目

| # | 項目 | 選択肢 |
|---|------|--------|
| Q1 | 映像解像度・FPS | Full HD/HD/VGA/カスタム |
| Q3 | 映像圧縮方式 | JPEG/H.264/RAW |
| Q4 | 通信インターフェース | USB/WiFi/Ethernet |
| Q6 | 録画トリガー | 常時/手動/動き検出/スケジュール |
| Q7 | ファイル保存形式 | MP4/MKV/JPEG連番 |
| Q10 | リアルタイム表示 | 必要/不要 |
| Q12 | 動き検出 | 必要/不要 |

### 🟡 次に確認が必要な項目

| # | 項目 |
|---|------|
| Q2 | HDR機能使用 |
| Q5 | 通信プロトコル |
| Q8 | ストレージ管理 |
| Q9 | ファイル分割 |
| Q13 | 複数カメラ対応 |
| Q20 | Spresense拡張ボード |
| Q21 | PC環境 |

### 🟢 後で確認できる項目

| # | 項目 |
|---|------|
| Q11 | 再生機能 |
| Q14 | タイムスタンプ・OSD |
| Q15 | 通知機能 |
| Q22 | Phase分け |
| Q23 | Rustクレート選定 |
| Q24 | セキュリティ要件 |
| Q25 | テスト環境 |

---

## 10. 次のステップ

### ステップ1: 要求確認

上記の質問（Q1-Q25）に回答してください。

### ステップ2: 仕様書作成

回答に基づき、以下を作成します:
1. 機能仕様書（詳細版）
2. ソフトウェア仕様書（Spresense側）
3. ソフトウェア仕様書（PC/Rust側）
4. 通信プロトコル仕様書
5. PlantUML図（アーキテクチャ、シーケンス等）

### ステップ3: プロトタイプ実装

仕様に基づき、Phase 1の実装を開始します。

---

## 付録A: 参考仕様（暫定案）

以下は、一般的な防犯カメラシステムの標準的な構成例です。
ユーザー要求に応じて調整します。

### 標準構成案

```yaml
映像:
  解像度: 1280x720 (HD)
  FPS: 30
  圧縮: H.264
  ビットレート: 2 Mbps

通信:
  インターフェース: USB CDC
  プロトコル: カスタムバイナリ

録画:
  トリガー: 常時録画
  形式: MP4
  分割: 1時間ごと
  保存期間: 7日間

表示:
  リアルタイム: あり（シンプルなGUI）

追加機能:
  動き検出: なし（Phase 2）
  複数カメラ: なし（Phase 2）
```

---

**文書バージョン**: 0.1 (ドラフト)
**最終更新**: 2025-12-14
**ステータス**: ✋ **ユーザー確認待ち**
